<?xml version="1.0" encoding="UTF-8" ?>

<rss version="2.0" xmlns:atom="http://www.w3.org/2005/Atom">
  <channel>
    
    <title>nju520.me</title>
    
    <link>http://localhost:4000</link>
    <description>nju520's Blog</description>
    <language>en-uk</language>
    <managingEditor> nju520</managingEditor>
    <atom:link href="rss" rel="self" type="application/rss+xml" />
    
<item>
  <title>è°ˆè°ˆ DSL ä»¥åŠ DSL çš„åº”ç”¨ï¼ˆä»¥ CocoaPods ä¸ºä¾‹ï¼‰</title>
  <link>//dsl</link>
  <author>nju520</author>
  <pubDate>2016-10-03T15:45:45+08:00</pubDate>
  <guid>//dsl</guid>
  <description><![CDATA[
  <blockquote>
  <p>æœ€è¿‘åœ¨å…¬å¸åšäº†ä¸€æ¬¡æœ‰å…³ DSL åœ¨ iOS å¼€å‘ä¸­çš„åº”ç”¨çš„åˆ†äº«ï¼Œè¿™ç¯‡æ–‡ç« ä¼šç®€å•ä»‹ç»è¿™æ¬¡åˆ†äº«çš„å†…å®¹ã€‚</p>

  <p>å› ä¸º DSL ä»¥åŠ DSL çš„ç•Œå®šæœ¬èº«å°±æ˜¯ä¸€ä¸ªæ¯”è¾ƒæ¨¡ç³Šçš„æ¦‚å¿µï¼Œæ‰€ä»¥éš¾å…æœ‰ä¸ä»–äººè§‚ç‚¹æ„è§ç›¸å·¦çš„åœ°æ–¹ï¼Œå¦‚æœæœ‰ä¸åŒçš„æ„è§ï¼Œæˆ‘ä»¬å¯ä»¥å…·ä½“è®¨è®ºã€‚</p>
</blockquote>

<p>è¿™æ¬¡æ–‡ç« çš„é¢˜ç›®è™½ç„¶æ˜¯è°ˆè°ˆ DSL ä»¥åŠ DSL çš„åº”ç”¨ï¼Œä¸è¿‡æ–‡ç« ä¸­ä¸»è¦ä¾§é‡ç‚¹ä»ç„¶æ˜¯ DSLï¼Œä¼šç®€å•ä»‹ç» DSL åœ¨ iOS å¼€å‘ä¸­ï¼ˆCocoaPodsï¼‰æ˜¯å¦‚ä½•åº”ç”¨çš„ã€‚</p>

<h2 id="æ²¡æœ‰é“¶å¼¹">æ²¡æœ‰é“¶å¼¹ï¼Ÿ</h2>

<p>1987 å¹´ï¼ŒIBM å¤§å‹ç”µè„‘ä¹‹çˆ¶ Fred Brooks å‘è¡¨äº†ä¸€ç¯‡å…³äºè½¯ä»¶å·¥ç¨‹ä¸­çš„è®ºæ–‡ <a href="No Silver Bulletâ€”Essence and Accidents of Software Engineering">No Silver Bulletâ€”Essence and Accidents of Software Engineering</a> æ–‡ä¸­ä¸»è¦å›´ç»•è¿™ä¹ˆä¸€ä¸ªè§‚ç‚¹ï¼šæ²¡æœ‰ä»»ä½•ä¸€ç§æŠ€æœ¯æˆ–è€…æ–¹æ³•èƒ½ä½¿è½¯ä»¶å·¥ç¨‹çš„ç”Ÿäº§åŠ›åœ¨åå¹´ä¹‹å†…æé«˜åå€ã€‚</p>

<blockquote>
  <p>There is no single development, in either technology or management technique, which by itself promises even one order-of-magnitude improvement within a decade in productivity, in reliability, in simplicity.</p>
</blockquote>

<p>æ—¶è‡³ä»Šæ—¥ï¼Œæˆ‘ä»¬æš‚ä¸”ä¸è°ˆé“¶å¼¹åœ¨è½¯ä»¶å·¥ç¨‹ä¸­æ˜¯å¦å­˜åœ¨ï¼ˆ<del>è¿™å¥è¯åœ¨è€æ¿æˆ–è€…é¡¹ç›®ç»ç†è¦æ±‚åŠ å¿«é¡¹ç›®è¿›åº¦æ—¶ï¼Œè¿˜æ˜¯ååˆ†å¥½ç”¨çš„</del>ï¼‰ï¼Œä½œä¸ºä¸€ä¸ªå¼€å‘è€…ä¹Ÿä¸æ˜¯å¾ˆå…³å¿ƒè¿™ç§æŠ½è±¡çš„ç†è®ºï¼Œæˆ‘ä»¬æ›´å…³å¿ƒçš„æ˜¯å¼€å‘æ•ˆç‡èƒ½å¦æœ‰å®è´¨çš„æå‡ã€‚</p>

<p><img src="https://img.nju520.me/2016-10-03-silver-bullet.jpg-1000width" alt="silver-bullet" /></p>

<p>è€Œä»Šå¤©è¦ä»‹ç»çš„ DSL å°±å¯ä»¥çœŸæ­£çš„æå‡ç”Ÿäº§åŠ›ï¼Œå‡å°‘ä¸å¿…è¦çš„å·¥ä½œï¼Œåœ¨ä¸€äº›é¢†åŸŸå¸®åŠ©æˆ‘ä»¬æ›´å¿«çš„å®ç°éœ€æ±‚ã€‚</p>

<h2 id="dsl-æ˜¯ä»€ä¹ˆ">DSL æ˜¯ä»€ä¹ˆï¼Ÿ</h2>

<blockquote>
  <p>ç¬”è€…æ˜¯åœ¨ä¸¤å¹´ä»¥å‰ï¼Œåœ¨å¤§ä¸€çš„ä¸€æ¬¡åˆ†äº«ä¸Šå¬åˆ° DSL è¿™ä¸ªè¯çš„ï¼Œä½†æ˜¯å½“æ—¶å¹¶æ²¡æœ‰å¯¹è¿™ä¸ªåè¯æœ‰å¤šæ·±çš„ç†è§£ä¸è®¤è¯†ï¼Œå¬è¿‡ä¹Ÿå°±å¿˜è®°äº†ï¼Œä½†æ˜¯æœ€è¿‘åšçš„ä¸€äº›å¼€æºé¡¹ç›®è®©æˆ‘é‡æ–°æƒ³èµ·äº† DSLï¼Œä¹Ÿæ˜¯è¿™æ¬¡åˆ†äº«é¢˜ç›®çš„ç”±æ¥ã€‚</p>
</blockquote>

<p>DSL å…¶å®æ˜¯ Domain Specific Language çš„ç¼©å†™ï¼Œä¸­æ–‡ç¿»è¯‘ä¸º<em>é¢†åŸŸç‰¹å®šè¯­è¨€</em>ï¼ˆä¸‹ç®€ç§° DSLï¼‰ï¼›è€Œä¸ DSL ç›¸å¯¹çš„å°±æ˜¯ GPLï¼Œè¿™é‡Œçš„ GPL å¹¶ä¸æ˜¯æˆ‘ä»¬çŸ¥é“çš„å¼€æºè®¸å¯è¯ï¼Œè€Œæ˜¯ General Purpose Language çš„ç®€ç§°ï¼Œå³<em>é€šç”¨ç¼–ç¨‹è¯­è¨€</em>ï¼Œä¹Ÿå°±æ˜¯æˆ‘ä»¬éå¸¸ç†Ÿæ‚‰çš„ Objective-Cã€Javaã€Python ä»¥åŠ C è¯­è¨€ç­‰ç­‰ã€‚</p>

<p><a href="https://en.wikipedia.org/wiki/Domain-specific_language">Wikipedia</a> å¯¹äº DSL çš„å®šä¹‰è¿˜æ˜¯æ¯”è¾ƒç®€å•çš„ï¼š</p>

<blockquote>
  <p>A specialized computer language designed for a specific task.</p>

  <p>ä¸ºäº†è§£å†³æŸä¸€ç±»ä»»åŠ¡è€Œä¸“é—¨è®¾è®¡çš„è®¡ç®—æœºè¯­è¨€ã€‚</p>
</blockquote>

<p>ä¸ GPL ç›¸å¯¹ï¼ŒDSL ä¸ä¼ ç»Ÿæ„ä¹‰ä¸Šçš„é€šç”¨ç¼–ç¨‹è¯­è¨€ Cã€Python ä»¥åŠ Haskell å®Œå…¨ä¸åŒã€‚é€šç”¨çš„è®¡ç®—æœºç¼–ç¨‹è¯­è¨€æ˜¯å¯ä»¥ç”¨æ¥ç¼–å†™ä»»æ„è®¡ç®—æœºç¨‹åºçš„ï¼Œå¹¶ä¸”èƒ½è¡¨è¾¾ä»»ä½•çš„<strong>å¯è¢«è®¡ç®—</strong>çš„é€»è¾‘ï¼ŒåŒæ—¶ä¹Ÿæ˜¯ <a href="https://en.wikipedia.org/wiki/Turing_completeness">å›¾çµå®Œå¤‡</a> çš„ã€‚</p>

<blockquote>
  <p>è¿™ä¸€å°èŠ‚ä¸­çš„ DSL æŒ‡å¤–éƒ¨ DSLï¼Œä¸‹ä¸€èŠ‚ä¸­ä¼šä»‹ç» <a href="#embedded-dslåµŒå…¥å¼-dsl">å†…éƒ¨ DSL/åµŒå…¥å¼ DSL</a></p>
</blockquote>

<p>ä½†æ˜¯åœ¨é‡Œæ‰€è¯´çš„ DSL å¹¶ä¸æ˜¯å›¾çµå®Œå¤‡çš„ï¼Œå®ƒä»¬çš„<strong>è¡¨è¾¾èƒ½åŠ›æœ‰é™</strong>ï¼Œåªæ˜¯åœ¨ç‰¹å®šé¢†åŸŸè§£å†³ç‰¹å®šä»»åŠ¡çš„ã€‚</p>

<blockquote>
  <p>A computer programming language of limited expressiveness focused on a particular domain.</p>
</blockquote>

<p>å¦ä¸€ä¸ªä¸–ç•Œçº§è½¯ä»¶å¼€å‘å¤§å¸ˆ Martin Fowler å¯¹äºé¢†åŸŸç‰¹å®šè¯­è¨€çš„å®šä¹‰åœ¨ç¬”è€…çœ‹æ¥å°±æ›´åŠ å…·ä½“äº†ï¼Œ<strong>DSL é€šè¿‡åœ¨è¡¨è¾¾èƒ½åŠ›ä¸Šåšçš„å¦¥åæ¢å–åœ¨æŸä¸€é¢†åŸŸå†…çš„é«˜æ•ˆ</strong>ã€‚</p>

<p>è€Œæœ‰é™çš„è¡¨è¾¾èƒ½åŠ›å°±æˆä¸ºäº† GPL å’Œ DSL ä¹‹é—´çš„ä¸€æ¡ç•Œé™ã€‚</p>

<h3 id="å‡ ä¸ªæ —å­">å‡ ä¸ªæ —å­</h3>

<p>æœ€å¸¸è§çš„ DSL åŒ…æ‹¬ Regex ä»¥åŠ HTML &amp; CSSï¼Œåœ¨è¿™é‡Œä¼šå¯¹è¿™å‡ ä¸ªä¾‹å­è¿›è¡Œç®€å•ä»‹ç»</p>

<ul>
  <li>Regex
    <ul>
      <li>æ­£åˆ™è¡¨è¾¾å¼ä»…ä»…æŒ‡å®šäº†å­—ç¬¦ä¸²çš„ patternï¼Œå…¶å¼•æ“å°±ä¼šæ ¹æ® pattern åˆ¤æ–­å½“å‰å­—ç¬¦ä¸²è·Ÿæ­£åˆ™è¡¨è¾¾å¼æ˜¯å¦åŒ¹é…ã€‚
  <img src="https://img.nju520.me/2016-10-03-regex.jpg-1000width" alt="regex" /></li>
    </ul>
  </li>
  <li>SQL
    <ul>
      <li>SQL è¯­å¥åœ¨ä½¿ç”¨æ—¶ä¹Ÿå¹¶æ²¡æœ‰çœŸæ­£çš„æ‰§è¡Œï¼Œæˆ‘ä»¬è¾“å…¥çš„ SQL è¯­å¥æœ€ç»ˆè¿˜è¦äº¤ç»™æ•°æ®åº“æ¥è¿›è¡Œå¤„ç†ï¼Œæ•°æ®åº“ä¼šä» SQL è¯­å¥ä¸­<strong>è¯»å–</strong>æœ‰ç”¨çš„ä¿¡æ¯ï¼Œç„¶åä»æ•°æ®åº“ä¸­è¿”å›ä½¿ç”¨è€…æœŸæœ›çš„ç»“æœã€‚</li>
    </ul>
  </li>
  <li>HTML &amp; CSS
    <ul>
      <li>HTML å’Œ CSS åªæ˜¯å¯¹ Web ç•Œé¢çš„ç»“æ„è¯­ä¹‰å’Œæ ·å¼è¿›è¡Œæè¿°ï¼Œè™½ç„¶å®ƒä»¬åœ¨æ„å»ºç½‘ç«™æ—¶éå¸¸é‡è¦ï¼Œä½†æ˜¯å®ƒä»¬å¹¶éæ˜¯ä¸€ç§ç¼–ç¨‹è¯­è¨€ï¼Œæ­£ç›¸åï¼Œæˆ‘ä»¬å¯ä»¥è®¤ä¸º HTML å’Œ CSS æ˜¯åœ¨ Web ä¸­çš„é¢†åŸŸç‰¹å®šè¯­è¨€ã€‚</li>
    </ul>
  </li>
</ul>

<h3 id="features">Features</h3>

<p>ä¸Šé¢çš„å‡ ä¸ªğŸŒ°æ˜æ˜¾çš„ç¼©å°äº†é€šç”¨ç¼–ç¨‹è¯­è¨€çš„æ¦‚å¿µï¼Œä½†æ˜¯å®ƒä»¬ç¡®å®åœ¨è‡ªå·±é¢†åŸŸè¡¨ç°åœ°éå¸¸å‡ºè‰²ï¼Œå› ä¸ºè¿™äº› DSL å°±æ˜¯æ ¹æ®æŸä¸€ä¸ªç‰¹å®šé¢†åŸŸçš„ç‰¹ç‚¹å¡‘é€ çš„ï¼›è€Œé€šç”¨ç¼–ç¨‹è¯­è¨€ç›¸æ¯”é¢†åŸŸç‰¹å®šè¯­è¨€ï¼Œåœ¨è®¾è®¡æ—¶æ˜¯ä¸ºäº†è§£å†³æ›´åŠ æŠ½è±¡çš„é—®é¢˜ï¼Œè€Œå…³æ³¨ç‚¹å¹¶ä¸åªæ˜¯åœ¨æŸä¸€ä¸ªé¢†åŸŸã€‚</p>

<p>ä¸Šé¢çš„å‡ ä¸ªä¾‹å­æœ‰ç€ä¸€äº›å…±åŒçš„ç‰¹ç‚¹ï¼š</p>

<ul>
  <li>æ²¡æœ‰è®¡ç®—å’Œæ‰§è¡Œçš„æ¦‚å¿µï¼›</li>
  <li>å…¶æœ¬èº«å¹¶ä¸éœ€è¦ç›´æ¥è¡¨ç¤ºè®¡ç®—ï¼›</li>
  <li>ä½¿ç”¨æ—¶åªéœ€è¦å£°æ˜è§„åˆ™ã€äº‹å®ä»¥åŠæŸäº›å…ƒç´ ä¹‹é—´çš„å±‚çº§å’Œå…³ç³»ï¼›</li>
</ul>

<p>è™½ç„¶äº†è§£äº† DSL ä»¥åŠ DSL çš„ä¸€äº›ç‰¹æ€§ï¼Œä½†æ˜¯ï¼Œåˆ°ç›®å‰ä¸ºæ­¢ï¼Œæˆ‘ä»¬å¯¹äºå¦‚ä½•æ„å»ºä¸€ä¸ª DSL ä»ç„¶ä¸æ˜¯å¾ˆæ¸…æ¥šã€‚</p>

<h3 id="æ„å»º-dsl">æ„å»º DSL</h3>

<p>DSL çš„æ„å»ºä¸ç¼–ç¨‹è¯­è¨€å…¶å®æ¯”è¾ƒç±»ä¼¼ï¼Œæƒ³æƒ³æˆ‘ä»¬åœ¨é‡æ–°å®ç°ç¼–ç¨‹è¯­è¨€æ—¶ï¼Œéœ€è¦åšé‚£äº›äº‹æƒ…ï¼›å®ç°ç¼–ç¨‹è¯­è¨€çš„è¿‡ç¨‹å¯ä»¥ç®€åŒ–ä¸ºå®šä¹‰è¯­æ³•ä¸è¯­ä¹‰ï¼Œç„¶åå®ç°ç¼–è¯‘å™¨æˆ–è€…è§£é‡Šå™¨çš„è¿‡ç¨‹ï¼Œè€Œ DSL çš„å®ç°ä¸å®ƒä¹Ÿéå¸¸ç±»ä¼¼ï¼Œæˆ‘ä»¬ä¹Ÿéœ€è¦å¯¹ DSL è¿›è¡Œè¯­æ³•ä¸è¯­ä¹‰ä¸Šçš„è®¾è®¡ã€‚</p>

<p><img src="https://img.nju520.me/2016-10-03-compiler.png-1000width" alt="compile" /></p>

<p>æ€»ç»“ä¸‹æ¥ï¼Œå®ç° DSL æ€»å…±æœ‰è¿™ä¹ˆä¸¤ä¸ªéœ€è¦å®Œæˆçš„å·¥ä½œï¼š</p>

<ol>
  <li>è®¾è®¡è¯­æ³•å’Œè¯­ä¹‰ï¼Œå®šä¹‰ DSL ä¸­çš„å…ƒç´ æ˜¯ä»€ä¹ˆæ ·çš„ï¼Œå…ƒç´ ä»£è¡¨ä»€ä¹ˆæ„æ€</li>
  <li>å®ç° parserï¼Œå¯¹ DSL è§£æï¼Œæœ€ç»ˆé€šè¿‡è§£é‡Šå™¨æ¥æ‰§è¡Œ</li>
</ol>

<p>ä»¥ HTML ä¸ºä¾‹ï¼ŒHTML ä¸­æ‰€æœ‰çš„å…ƒç´ éƒ½æ˜¯åŒ…å«åœ¨å°–æ‹¬å· <code>&lt;&gt;</code> ä¸­çš„ï¼Œå°–æ‹¬å·ä¸­ä¸åŒçš„å…ƒç´ ä»£è¡¨äº†ä¸åŒçš„æ ‡ç­¾ï¼Œè€Œè¿™äº›æ ‡ç­¾ä¼šè¢«æµè§ˆå™¨<strong>è§£æ</strong>æˆ DOM æ ‘ï¼Œå†ç»è¿‡ä¸€ç³»åˆ—çš„è¿‡ç¨‹è°ƒç”¨ Native çš„å›¾å½¢ API è¿›è¡Œç»˜åˆ¶ã€‚</p>

<p><img src="https://img.nju520.me/2016-10-03-dom-tree.png-1000width" alt="dom-tree" /></p>

<p>å†æ¯”å¦‚ï¼Œæˆ‘ä»¬ä½¿ç”¨ä¸‹é¢è¿™ç§æ–¹å¼å¯¹ä¸€ä¸ªæ¨¡å‹è¿›è¡Œå®šä¹‰ï¼Œå®ç°ä¸€ä¸ª ORM é¢†åŸŸçš„ DSLï¼š</p>

<pre><code class="language-ruby">define :article do
  attr :name
  attr :content
  attr :upvotes, :int

  has_many :comments
end
</code></pre>

<p>åœ¨ä¸Šé¢çš„ DSL ä¸­ï¼Œä½¿ç”¨ <code>define</code> æ¥å®šä¹‰ä¸€ä¸ªæ–°çš„æ¨¡å‹ï¼Œä½¿ç”¨ <code>attr</code> æ¥ä¸ºæ¨¡å‹æ·»åŠ å±æ€§ï¼Œä½¿ç”¨ <code>has_many</code> å»ºç«‹æ•°æ®æ¨¡å‹ä¸­çš„ä¸€å¯¹å¤šå…³ç³»ï¼›æˆ‘ä»¬å¯ä»¥ä½¿ç”¨ DSL å¯¹è¿™æ®µâ€œå­—ç¬¦ä¸²â€è¿›è¡Œè§£æï¼Œç„¶åäº¤ç»™ä»£ç ç”Ÿæˆå™¨æ¥ç”Ÿæˆä»£ç ã€‚</p>

<pre><code class="language-swift">public struct Article {
    public var title: String
    public var content: String
    public var createdAt: Date

    public init(title: String, content: String, createdAt: Date)

    static public func new(title: String, content: String, createdAt: Date) -&gt; Article
    static public func create(title: String, content: String, createdAt: Date) -&gt; Article?
    ...
}
</code></pre>

<p>è¿™é‡Œåˆ›å»ºçš„ DSL ä¸­çš„å…ƒç´ æ•°é‡éå¸¸å°‘ï¼Œåªæœ‰ <code>define</code> <code>attr</code> ä»¥åŠ <code>has_many</code> ç­‰å‡ ä¸ªå…³é”®å­—ï¼Œä½†æ˜¯é€šè¿‡è¿™å‡ ä¸ªå…³é”®å­—å°±å¯ä»¥å®Œæˆåœ¨æ¨¡å‹å±‚éœ€è¦è¡¨è¾¾çš„ç»å¤§éƒ¨åˆ†è¯­ä¹‰ã€‚</p>

<h3 id="è®¾è®¡åŸåˆ™å’Œå¦¥å">è®¾è®¡åŸåˆ™å’Œå¦¥å</h3>

<p>DSL æœ€å¤§çš„è®¾è®¡åŸåˆ™å°±æ˜¯<strong>ç®€å•</strong>ï¼Œé€šè¿‡ç®€åŒ–è¯­è¨€ä¸­çš„å…ƒç´ ï¼Œé™ä½ä½¿ç”¨è€…çš„è´Ÿæ‹…ï¼›æ— è®ºæ˜¯ Regexã€SQL è¿˜æ˜¯ HTML ä»¥åŠ CSSï¼Œå…¶è¯´æ˜æ–‡æ¡£å¾€å¾€åªæœ‰å‡ é¡µï¼Œéå¸¸æ˜“äºå­¦ä¹ å’ŒæŒæ¡ã€‚ä½†æ˜¯ï¼Œç”±æ­¤å¸¦æ¥çš„é—®é¢˜å°±æ˜¯ï¼ŒDSL ä¸­ç¼ºä¹æŠ½è±¡çš„æ¦‚å¿µï¼Œæ¯”å¦‚ï¼šæ¨¡å—åŒ–ã€å˜é‡ä»¥åŠæ–¹æ³•ç­‰ã€‚</p>

<blockquote>
  <p>æŠ½è±¡çš„æ¦‚å¿µå¹¶ä¸æ˜¯æŸä¸ªé¢†åŸŸæ‰€å…³æ³¨çš„é—®é¢˜ï¼Œå°±åƒ Regex å¹¶ä¸éœ€è¦æœ‰æ¨¡å—ã€å˜é‡ä»¥åŠæ–¹æ³•ç­‰æ¦‚å¿µã€‚</p>
</blockquote>

<p>ç”±äºæŠ½è±¡èƒ½åŠ›çš„ç¼ºä¹ï¼Œåœ¨æˆ‘ä»¬çš„é¡¹ç›®è§„æ¨¡å˜å¾—è¶Šæ¥è¶Šå¤§æ—¶ï¼ŒDSL å¾€å¾€æ»¡è¶³ä¸äº†å¼€å‘è€…çš„éœ€æ±‚ï¼›æˆ‘ä»¬ä»ç„¶éœ€è¦ç¼–ç¨‹è¯­è¨€ä¸­çš„æ¨¡å—åŒ–ç­‰æ¦‚å¿µå¯¹ DSL è¿›è¡Œè¡¥å……ï¼Œä»¥æ­¤è§£å†³ DSL å¹¶ä¸æ˜¯çœŸæ­£ç¼–ç¨‹è¯­è¨€çš„é—®é¢˜ã€‚</p>

<p><img src="https://img.nju520.me/2016-10-03-css-sass.jpg-1000width" alt="css-sass" /></p>

<p>åœ¨å½“ä»Šçš„ Web å‰ç«¯é¡¹ç›®ä¸­ï¼Œæˆ‘ä»¬åœ¨å¼€å‘å¤§è§„æ¨¡é¡¹ç›®æ—¶å¾€å¾€ä¸ä¼šç›´æ¥æ‰‹å†™ CSS æ–‡ä»¶ï¼Œè€Œæ˜¯ä¼šä½¿ç”¨ Sass æˆ–è€… Less ä¸º CSS å¸¦æ¥æ›´å¼ºå¤§çš„æŠ½è±¡èƒ½åŠ›ï¼Œæ¯”å¦‚åµŒå¥—è§„åˆ™ï¼Œå˜é‡ï¼Œæ··åˆä»¥åŠç»§æ‰¿ç­‰ç‰¹æ€§ã€‚</p>

<pre><code class="language-css">nav {
  ul {
    margin: 0;
    padding: 0;
    list-style: none;
  }

  li { display: inline-block; }

  a {
    display: block;
    padding: 6px 12px;
    text-decoration: none;
  }
}
</code></pre>

<p>ä¹Ÿå°±æ˜¯è¯´ï¼Œåœ¨ä½¿ç”¨ DSL çš„é¡¹ç›®è§„æ¨¡é€æ¸å˜å¤§æ—¶ï¼Œå¼€å‘è€…ä¼šé€šè¿‡å¢åŠ æŠ½è±¡èƒ½åŠ›çš„æ–¹å¼ï¼Œå¯¹å·²æœ‰çš„ DSL è¿›è¡Œæ‹“å±•ï¼›ä½†æ˜¯è¿™ç§æ‰©å±•å¾€å¾€éœ€è¦é‡æ–°å®ç°é€šç”¨ç¼–ç¨‹è¯­è¨€ä¸­çš„ç‰¹æ€§ï¼Œæ‰€ä»¥ä¸€èˆ¬æƒ…å†µä¸‹éƒ½æ˜¯æ¯”è¾ƒå¤æ‚çš„ã€‚</p>

<h2 id="embedded-dslåµŒå…¥å¼-dsl">Embedded DSLï¼ˆåµŒå…¥å¼ DSLï¼‰</h2>

<p>é‚£ä¹ˆï¼Œæ˜¯å¦æœ‰ä¸€ç§å…¶å®ƒçš„æ–¹æ³•ä¸º DSL å¿«é€Ÿæ·»åŠ æŠ½è±¡èƒ½åŠ›å‘¢ï¼Ÿè€Œè¿™ä¹Ÿå°±æ˜¯è¿™ä¸€å°èŠ‚çš„ä¸»é¢˜ï¼ŒåµŒå…¥å¼ DSLã€‚</p>

<p>åœ¨ä¸Šä¸€èŠ‚è®²åˆ°çš„ DSL å…¶å®å¯ä»¥è¢«ç§°ä¸ºå¤–éƒ¨ DSLï¼›è€Œè¿™é‡Œå³å°†è°ˆåˆ°çš„åµŒå…¥å¼ DSL ä¹Ÿæœ‰ä¸€ä¸ªåˆ«åï¼Œå†…éƒ¨ DSLã€‚</p>

<p>è¿™ä¸¤è€…æœ€å¤§çš„åŒºåˆ«å°±æ˜¯ï¼Œå†…éƒ¨ DSL çš„å®ç°å¾€å¾€æ˜¯åµŒå…¥ä¸€äº›ç¼–ç¨‹è¯­è¨€çš„ï¼Œæ¯”å¦‚ iOS çš„ä¾èµ–ç®¡ç†ç»„ä»¶ CocoaPods å’Œ Android çš„ä¸»æµç¼–è¯‘å·¥å…· Gradleï¼Œå‰è€…çš„å®ç°æ˜¯åŸºäº Ruby è¯­è¨€çš„ä¸€äº›ç‰¹æ€§ï¼Œè€Œåè€…åŸºäº Groovyã€‚</p>

<p><img src="https://img.nju520.me/2016-10-03-cocoapods.png-1000width" alt="cocoapods" /></p>

<p>CocoaPods ä»¥åŠå…¶å®ƒçš„åµŒå…¥å¼ DSL ä½¿ç”¨äº†å®¿ä¸»è¯­è¨€ï¼ˆhost languageï¼‰çš„æŠ½è±¡èƒ½åŠ›ï¼Œå¹¶ä¸”çœå»äº†å®ç°å¤æ‚è¯­æ³•åˆ†æå™¨ï¼ˆParserï¼‰çš„è¿‡ç¨‹ï¼Œå¹¶ä¸éœ€è¦é‡æ–°å®ç°æ¨¡å—ã€å˜é‡ç­‰ç‰¹æ€§ã€‚</p>

<p>åµŒå…¥å¼ DSL çš„äº§ç”Ÿå…¶å®æ¨¡ç³Šäº†æ¡†æ¶å’Œ DSL çš„è¾¹ç•Œï¼Œä¸è¿‡è¿™ä¸¤è€…çœ‹èµ·æ¥ä¹Ÿæ²¡æœ‰ä»€ä¹ˆæ¯”è¾ƒæ˜æ˜¾çš„åŒºåˆ«ï¼›ä¸è¿‡ï¼ŒDSL ä¸€èˆ¬ä¼šä½¿ç”¨å®¿ä¸»è¯­è¨€çš„ç‰¹æ€§è¿›è¡Œåˆ›é€ ï¼Œåœ¨è®¾è®¡ DSL æ—¶ï¼Œä¹Ÿä¸ä¼šè€ƒè™‘å®¿ä¸»è¯­è¨€ä¸­æœ‰å“ªäº› API ä»¥åŠæ–¹æ³•ï¼Œè€Œæ¡†æ¶ä¸€èˆ¬éƒ½æ˜¯å¯¹è¯­è¨€ä¸­çš„ API è¿›è¡Œç»„åˆå’Œå†åŒ…è£…ã€‚</p>

<blockquote>
  <p>æˆ‘ä»¬æ²¡æœ‰å¿…è¦äº‰è®ºå“ªäº›æ˜¯æ¡†æ¶ï¼Œå“ªäº›æ˜¯ DSLï¼Œå› ä¸ºè¿™äº›äº‰è®ºå¹¶æ²¡æœ‰ä»€ä¹ˆæ„ä¹‰ã€‚</p>
</blockquote>

<h3 id="rails-å’Œ-embedded-dsl">Rails å’Œ Embedded DSL</h3>

<p>æœ€å‡ºåä¹Ÿæœ€æˆåŠŸçš„åµŒå…¥å¼ DSL åº”è¯¥å°±æ˜¯ Ruby on Rails äº†ï¼Œè™½ç„¶å¯¹äº Rails æ˜¯å¦æ˜¯ DSL æœ‰äº‰è®®ï¼Œä¸è¿‡ Rails ä¸º Web åº”ç”¨çš„åˆ›å»ºæä¾›å¤§é‡çš„å†…ç½®çš„æ”¯æ’‘ï¼Œä½¿æˆ‘ä»¬åœ¨å¼€å‘ Web åº”ç”¨æ—¶å˜å¾—éå¸¸å®¹æ˜“ã€‚</p>

<p><img src="https://img.nju520.me/2016-10-03-rails.jpeg" alt="rails" /></p>

<h2 id="ruby-dsl-å’Œ-ios">Rubyã€ DSL å’Œ iOS</h2>

<blockquote>
  <p>ä¸ºäº†ä¿è¯è¿™ç¯‡æ–‡ç« çš„å®Œæ•´æ€§ï¼Œè¿™ä¸€å°èŠ‚ä¸­æœ‰çš„ä¸€äº›å†…å®¹éƒ½å‡ºè‡ªä¸Šä¸€ç¯‡æ–‡ç«  <a href="https://github.com/nju520/iOS-Source-Code-Analyze/blob/master/contents/CocoaPods/CocoaPods%20éƒ½åšäº†ä»€ä¹ˆï¼Ÿ.md">CocoaPods éƒ½åšäº†ä»€ä¹ˆï¼Ÿ</a>ã€‚</p>
</blockquote>

<p>ç¬”è€…åŒæ—¶ä½œä¸º iOS å’Œ Rails å¼€å‘è€…æ¥è§¦äº†éå¸¸å¤šçš„ DSLï¼Œè€Œåœ¨ iOS å¼€å‘ä¸­æœ€å¸¸è§çš„ DSL å°±æ˜¯ CocoaPods äº†ï¼Œè€Œè¿™é‡Œæˆ‘ä»¬ä»¥ CocoaPods ä¸ºä¾‹ï¼Œä»‹ç»å¦‚ä½•ä½¿ç”¨ Ruby åˆ›é€ ä¸€ä¸ªåµŒå…¥å¼ DSLã€‚</p>

<h3 id="why-ruby">Why Rubyï¼Ÿ</h3>

<p>çœ‹åˆ°è¿™é‡Œæœ‰äººå¯èƒ½ä¼šé—®äº†ï¼Œä¸ºä»€ä¹ˆä½¿ç”¨ Ruby åˆ›é€ åµŒå…¥å¼ DSLï¼Œè€Œä¸æ˜¯ä½¿ç”¨ Cã€Javaã€Python ç­‰ç­‰è¯­è¨€å‘¢ï¼Œè¿™é‡Œå¤§æ¦‚æœ‰å››ä¸ªåŸå› ï¼š</p>

<ul>
  <li>ä¸€åˆ‡çš†å¯¹è±¡çš„ç‰¹æ€§å‡å°‘äº†è¯­è¨€ä¸­çš„å…ƒç´ ï¼Œä¸å­˜åœ¨åŸºæœ¬ç±»å‹ã€æ“ä½œç¬¦ï¼›</li>
  <li>å‘ Ruby æ–¹æ³•ä¸­ä¼ å…¥ä»£ç å—éå¸¸æ–¹ä¾¿ï¼›</li>
  <li>ä½œä¸ºè§£é‡Šæ‰§è¡Œçš„è¯­è¨€ï¼Œeval æ¨¡ç³Šäº†æ•°æ®å’Œä»£ç çš„è¾¹ç•Œï¼›</li>
  <li>ä¸å¯¹ä»£ç çš„æ ¼å¼è¿›è¡Œçº¦æŸï¼ŒåŒæ—¶ä¸€äº›çº¦å®šå‡å°‘äº†ä»£ç ä¸­çš„å™ªéŸ³ã€‚</li>
</ul>

<h4 id="ä¸€åˆ‡çš†å¯¹è±¡">ä¸€åˆ‡çš†å¯¹è±¡</h4>

<p>åœ¨è®¸å¤šè¯­è¨€ï¼Œæ¯”å¦‚ Java ä¸­ï¼Œæ•°å­—ä¸å…¶ä»–çš„åŸºæœ¬ç±»å‹éƒ½ä¸æ˜¯å¯¹è±¡ï¼Œè€Œåœ¨ Ruby ä¸­æ‰€æœ‰çš„å…ƒç´ ï¼ŒåŒ…æ‹¬åŸºæœ¬ç±»å‹éƒ½æ˜¯å¯¹è±¡ï¼ŒåŒæ—¶ä¹Ÿä¸å­˜åœ¨è¿ç®—ç¬¦çš„æ¦‚å¿µï¼Œæ‰€è°“çš„ <code>1 + 1</code>ï¼Œå…¶å®åªæ˜¯ <code>1.+(1)</code> çš„è¯­æ³•ç³–è€Œå·²ã€‚</p>

<p>å¾—ç›Šäºä¸€åˆ‡çš†å¯¹è±¡çš„æ¦‚å¿µï¼Œåœ¨ Ruby ä¸­ï¼Œä½ å¯ä»¥å‘ä»»æ„çš„å¯¹è±¡å‘é€ <code>methods</code> æ¶ˆæ¯ï¼Œåœ¨è¿è¡Œæ—¶è‡ªçœï¼Œæ‰€ä»¥ç¬”è€…åœ¨æ¯æ¬¡å¿˜è®°æ–¹æ³•æ—¶ï¼Œéƒ½ä¼šç›´æ¥ç”¨ <code>methods</code> æ¥â€œæŸ¥é˜…æ–‡æ¡£â€ï¼š</p>

<pre><code class="language-ruby">2.3.1 :003 &gt; 1.methods
 =&gt; [:%, :&amp;, :*, :+, :-, :/, :&lt;, :&gt;, :^, :|, :~, :-@, :**, :&lt;=&gt;, :&lt;&lt;, :&gt;&gt;, :&lt;=, :&gt;=, :==, :===, :[], :inspect, :size, :succ, :to_s, :to_f, :div, :divmod, :fdiv, :modulo, ...]
</code></pre>

<p>æ¯”å¦‚åœ¨è¿™é‡Œå‘å¯¹è±¡ <code>1</code> è°ƒç”¨ <code>methods</code> å°±ä¼šè¿”å›å®ƒèƒ½å“åº”çš„æ‰€æœ‰æ–¹æ³•ã€‚</p>

<p>ä¸€åˆ‡çš†å¯¹è±¡ä¸ä»…å‡å°‘äº†è¯­è¨€ä¸­ç±»å‹çš„æ•°é‡ï¼Œæ¶ˆç­äº†åŸºæœ¬æ•°æ®ç±»å‹ä¸å¯¹è±¡ä¹‹é—´çš„è¾¹ç•Œï¼›è¿™ä¸€æ¦‚å¿µåŒæ—¶ä¹Ÿç®€åŒ–äº†ç»„æˆè¯­è¨€çš„å…ƒç´ ï¼Œè¿™æ · Ruby ä¸­åªæœ‰å¯¹è±¡å’Œæ–¹æ³•ï¼Œè¿™ä¸¤ä¸ªæ¦‚å¿µï¼Œæå¤§é™ä½äº†è¿™é—¨è¯­è¨€çš„å¤æ‚åº¦ï¼š</p>

<ul>
  <li>ä½¿ç”¨å¯¹è±¡å­˜å‚¨çŠ¶æ€</li>
  <li>å¯¹è±¡ä¹‹é—´é€šè¿‡æ–¹æ³•é€šä¿¡</li>
</ul>

<h4 id="block">block</h4>

<p>Ruby å¯¹å‡½æ•°å¼ç¼–ç¨‹èŒƒå¼çš„æ”¯æŒæ˜¯é€šè¿‡ blockï¼Œè¿™é‡Œçš„ block å’Œ Objective-C ä¸­çš„ block æœ‰äº›ä¸åŒã€‚</p>

<p>é¦–å…ˆ Ruby ä¸­çš„ block ä¹Ÿæ˜¯ä¸€ç§å¯¹è±¡ï¼Œå³ <code>Proc</code> ç±»çš„å®ä¾‹ï¼Œä¹Ÿå°±æ˜¯æ‰€æœ‰çš„ block éƒ½æ˜¯ first-class çš„ï¼Œå¯ä»¥ä½œä¸ºå‚æ•°ä¼ é€’ï¼Œè¿”å›ã€‚</p>

<p>ä¸‹é¢çš„ä»£ç æ¼”ç¤ºäº†ä¸¤ç§å‘ Ruby æ–¹æ³•ä¸­ä¼ å…¥ä»£ç å—çš„æ–¹å¼ï¼š</p>

<pre><code class="language-ruby">def twice(&amp;proc)
	2.times { proc.call() } if proc
end

def twice
	2.times { yield } if block_given?
end
</code></pre>

<p><code>yield</code> ä¼šè°ƒç”¨å¤–éƒ¨ä¼ å…¥çš„ blockï¼Œ<code>block_given?</code> ç”¨äºåˆ¤æ–­å½“å‰æ–¹æ³•æ˜¯å¦ä¼ å…¥äº† <code>block</code>ã€‚</p>

<pre><code class="language-ruby">twice do
	puts "Hello"
end

twice { puts "hello" }
</code></pre>

<p>å‘ <code>twice</code> æ–¹æ³•ä¼ å…¥ block ä¹Ÿéå¸¸ç®€å•ï¼Œä½¿ç”¨ <code>do</code>ã€<code>end</code> æˆ–è€… <code>{</code>ã€<code>}</code> å°±å¯ä»¥å‘ä»»ä½•çš„ Ruby æ–¹æ³•ä¸­ä¼ å…¥ä»£ç å—ã€‚</p>

<h4 id="eval">eval</h4>

<p>æ—©åœ¨å‡ åå¹´å‰çš„ Lisp è¯­è¨€å°±æœ‰äº† <code>eval</code> è¿™ä¸ªæ–¹æ³•ï¼Œè¿™ä¸ªæ–¹æ³•ä¼šå°†å­—ç¬¦ä¸²å½“åšä»£ç æ¥æ‰§è¡Œï¼Œä¹Ÿå°±æ˜¯è¯´ <code>eval</code> æ¨¡ç³Šäº†ä»£ç ä¸æ•°æ®ä¹‹é—´çš„è¾¹ç•Œã€‚</p>

<pre><code class="language-ruby">&gt; eval "1 + 2 * 3"
 =&gt; 7
</code></pre>

<p>æœ‰äº† <code>eval</code> æ–¹æ³•ï¼Œæˆ‘ä»¬å°±è·å¾—äº†æ›´åŠ å¼ºå¤§çš„åŠ¨æ€èƒ½åŠ›ï¼Œåœ¨è¿è¡Œæ—¶ï¼Œä½¿ç”¨å­—ç¬¦ä¸²æ¥æ”¹å˜æ§åˆ¶æµç¨‹ï¼Œæ‰§è¡Œä»£ç å¹¶å¯ä»¥ç›´æ¥åˆ©ç”¨å½“å‰è¯­è¨€çš„è§£é‡Šå™¨ï¼›è€Œä¸éœ€è¦å»æ‰‹åŠ¨è§£æå­—ç¬¦ä¸²ç„¶åæ‰§è¡Œä»£ç ã€‚</p>

<h4 id="æ ¼å¼å’Œçº¦å®š">æ ¼å¼å’Œçº¦å®š</h4>

<p>ç¼–å†™ Ruby è„šæœ¬æ—¶å¹¶ä¸éœ€è¦åƒ Python ä¸€æ ·å¯¹ä»£ç çš„æ ¼å¼æœ‰ç€ä¸¥æ ¼çš„è§„å®šï¼Œæ²¡æœ‰å¯¹ç©ºè¡Œã€Tab çš„è¦æ±‚ï¼Œå®Œå…¨å¯ä»¥æƒ³æ€ä¹ˆå†™å°±æ€ä¹ˆå†™ï¼Œè¿™æ ·æå¤§çš„å¢åŠ äº† DSL è®¾è®¡çš„å¯èƒ½æ€§ã€‚</p>

<p>åŒæ—¶ï¼Œåœ¨ä¸€èˆ¬æƒ…å†µä¸‹ï¼ŒRuby åœ¨æ–¹æ³•è°ƒç”¨æ—¶å¹¶ä¸éœ€è¦æ·»åŠ æ‹¬å·ï¼š</p>

<pre><code class="language-ruby">puts "Wello World!"
puts("Hello World!")
</code></pre>

<p>è¿™æ ·å‡å°‘äº† DSL ä¸­çš„å™ªéŸ³ï¼Œèƒ½å¤Ÿå¸®åŠ©æˆ‘ä»¬æ›´åŠ å…³å¿ƒè¯­æ³•ä»¥åŠè¯­ä¹‰ä¸Šçš„è®¾è®¡ï¼Œé™ä½äº†ä½¿ç”¨è€…å‡ºé”™çš„å¯èƒ½æ€§ã€‚</p>

<p>æœ€åï¼ŒRuby ä¸­å­˜åœ¨ä¸€ç§ç‰¹æ®Šçš„æ•°æ®æ ¼å¼ <code>Symbol</code>ï¼š</p>

<pre><code class="language-ruby">&gt; :symbol.to_s
 =&gt; "symbol"
&gt; "symbol".to_sym
 =&gt; :symbol
</code></pre>

<p>Symbol å¯ä»¥é€šè¿‡ Ruby ä¸­å†…ç½®çš„æ–¹æ³•ä¸å­—ç¬¦ä¸²ä¹‹é—´æ— ç¼è½¬æ¢ã€‚é‚£ä¹ˆä½œä¸ºä¸€ç§å­—ç¬¦ä¸²çš„æ›¿ä»£å“ï¼Œå®ƒçš„ä½¿ç”¨ä¹Ÿèƒ½å¤Ÿé™ä½ä½¿ç”¨è€…å‡ºé”™çš„æˆæœ¬å¹¶æå‡ä½¿ç”¨ä½“éªŒï¼Œæˆ‘ä»¬å¹¶ä¸éœ€è¦å»å†™ä¸¤è¾¹åŠ ä¸Šå¼•å·çš„å­—ç¬¦ä¸²ï¼Œåªéœ€è¦ä»¥ <code>:</code> å¼€å¤´å°±èƒ½åˆ›å»ºä¸€ä¸ª Symbol å¯¹è±¡ã€‚</p>

<h3 id="podfile-æ˜¯ä»€ä¹ˆ">Podfile æ˜¯ä»€ä¹ˆ</h3>

<p>å¯¹ Ruby æœ‰äº†ä¸€äº›äº†è§£ä¹‹åï¼Œæˆ‘ä»¬å°±å¯ä»¥å†çœ‹ä¸€ä¸‹ä½¿ç”¨ CocoaPods çš„å·¥ç¨‹ä¸­çš„ Podfile åˆ°åº•æ˜¯ä»€ä¹ˆäº†ï¼š</p>

<pre><code class="language-ruby">source 'https://github.com/CocoaPods/Specs.git'

target 'Demo' do
	pod 'Mantle', '~&gt; 1.5.1'
	...
end
</code></pre>

<blockquote>
  <p>å¦‚æœä¸äº†è§£ iOS å¼€å‘åè€…æ²¡æœ‰ä½¿ç”¨è¿‡ CocoaPodsï¼Œç¬”è€…åœ¨è¿™é‡Œç®€å•ä»‹ç»ä¸€ä¸‹è¿™ä¸ªæ–‡ä»¶ä¸­çš„ä¸€äº›ä¿¡æ¯ã€‚</p>

  <p><code>source</code> å¯ä»¥çœ‹ä½œæ˜¯å­˜å‚¨ä¾èµ–å…ƒä¿¡æ¯ï¼ˆåŒ…æ‹¬ä¾èµ–çš„å¯¹åº”çš„  GitHub åœ°å€ï¼‰çš„æºåœ°å€ï¼›</p>

  <p><code>target</code> è¡¨ç¤ºéœ€è¦æ·»åŠ ä¾èµ–çš„å·¥ç¨‹çš„åå­—ï¼›</p>

  <p><code>pod</code> è¡¨ç¤ºä¾èµ–ï¼Œ<code>Mantle</code> ä¸ºä¾èµ–çš„æ¡†æ¶ï¼Œåé¢æ˜¯ç‰ˆæœ¬å·ã€‚</p>
</blockquote>

<p>ä¸Šé¢æ˜¯ä¸€ä¸ªä½¿ç”¨ Podfile å®šä¹‰ä¾èµ–çš„ä¸€ä¸ªä¾‹å­ï¼Œä¸è¿‡ Podfile å¯¹çº¦æŸçš„æè¿°å…¶å®æ˜¯è¿™æ ·çš„ï¼š</p>

<pre><code class="language-ruby">source('https://github.com/CocoaPods/Specs.git')

target('Demo') do
	pod('Mantle', '~&gt; 1.5.1')
	...
end
</code></pre>

<p>Podfile ä¸­å¯¹äºçº¦æŸçš„æè¿°ï¼Œå…¶å®éƒ½å¯ä»¥çœ‹ä½œæ˜¯ä»£ç çš„ç®€å†™ï¼Œåœ¨è§£ææ—¶ä¼šå½“åš Ruby ä»£ç æ¥æ‰§è¡Œã€‚</p>

<h3 id="ç®€å•æä¸ª-embedded-dsl">ç®€å•æä¸ª Embedded DSL</h3>

<p>ä½¿ç”¨ Ruby å®ç°åµŒå…¥å¼ DSL ä¸€èˆ¬éœ€è¦ä¸‰ä¸ªæ­¥éª¤ï¼Œè¿™é‡Œä»¥ CocoaPods ä¸ºä¾‹è¿›è¡Œç®€å•ä»‹ç»ï¼š</p>

<ul>
  <li>åˆ›å»ºä¸€ä¸ª Podfile ä¸­â€œä»£ç â€æ‰§è¡Œçš„ä¸Šä¸‹æ–‡ï¼Œä¹Ÿå°±æ˜¯ä¸€äº›æ–¹æ³•ï¼›</li>
  <li>è¯»å– Podfile ä¸­çš„å†…å®¹åˆ°è„šæœ¬ä¸­ï¼›</li>
  <li>ä½¿ç”¨ <code>eval</code> åœ¨ä¸Šä¸‹æ–‡ä¸­æ‰§è¡Œ Podfile ä¸­çš„â€œä»£ç â€ï¼›</li>
</ul>

<h4 id="åŸç†">åŸç†</h4>

<p>CocoaPods å¯¹äº DSL çš„å®ç°åŸºæœ¬ä¸Šå°±æ˜¯æˆ‘ä»¬åˆ›å»ºä¸€ä¸ª DSL çš„è¿‡ç¨‹ï¼Œå®šä¹‰ä¸€ç³»åˆ—å¿…è¦çš„æ–¹æ³•ï¼Œæ¯”å¦‚ <code>source</code>ã€<code>pod</code> ç­‰ç­‰ï¼Œåˆ›é€ ä¸€ä¸ªæ‰§è¡Œçš„ä¸Šä¸‹æ–‡ï¼›ç„¶åå»è¯»å­˜å‚¨ DSL çš„æ–‡ä»¶ï¼Œå¹¶ä¸”ä½¿ç”¨ <code>eval</code> æ‰§è¡Œã€‚</p>

<p><strong>ä¿¡æ¯çš„ä¼ é€’ä¸€èˆ¬éƒ½æ˜¯é€šè¿‡å‚æ•°</strong>æ¥è¿›è¡Œçš„ï¼Œæ¯”å¦‚ï¼š</p>

<pre><code class="language-ruby">source 'https://github.com/CocoaPods/Specs.git'
</code></pre>

<p><code>source</code> æ–¹æ³•çš„å‚æ•°å°±æ˜¯ä¾èµ–å…ƒä¿¡æ¯ <code>Specs</code> çš„ Git åœ°å€ï¼Œåœ¨ <code>eval</code> æ‰§è¡Œæ—¶å°±ä¼šè¢«è¯»å–åˆ° CocoaPods ä¸­ï¼Œç„¶åè¿›è¡Œåˆ†æã€‚</p>

<h4 id="å®ç°">å®ç°</h4>

<p>ä¸‹é¢æ˜¯ä¸€ä¸ªéå¸¸å¸¸è§çš„ Podfile å†…å®¹ï¼š</p>

<pre><code class="language-ruby">source 'http://source.git'
platform :ios, '8.0'

target 'Demo' do
    pod 'AFNetworking'
    pod 'SDWebImage'
    pod 'Masonry'
    pod "Typeset"
    pod 'BlocksKit'
    pod 'Mantle'
    pod 'IQKeyboardManager'
    pod 'IQDropDownTextField'
end
</code></pre>

<p>å› ä¸ºè¿™é‡Œçš„ <code>source</code>ã€<code>platform</code>ã€<code>target</code> ä»¥åŠ <code>pod</code> éƒ½æ˜¯æ–¹æ³•ï¼Œæ‰€ä»¥åœ¨è¿™é‡Œæˆ‘ä»¬éœ€è¦æ„å»ºä¸€ä¸ªåŒ…å«ä¸Šè¿°æ–¹æ³•çš„ä¸Šä¸‹æ–‡ï¼š</p>

<pre><code class="language-ruby"># eval_pod.rb
$hash_value = {}

def source(url)
end

def target(target)
end

def platform(platform, version)
end

def pod(pod)
end
</code></pre>

<p>ä½¿ç”¨ä¸€ä¸ªå…¨å±€å˜é‡ <code>hash_value</code> å­˜å‚¨ Podfile ä¸­æŒ‡å®šçš„ä¾èµ–ï¼Œå¹¶ä¸”æ„å»ºäº†ä¸€ä¸ª Podfile è§£æè„šæœ¬çš„éª¨æ¶ï¼›æˆ‘ä»¬å…ˆä¸å»å®Œå–„è¿™äº›æ–¹æ³•çš„å®ç°ç»†èŠ‚ï¼Œå…ˆå°è¯•ä¸€ä¸‹è¯»å– Podfile ä¸­çš„å†…å®¹å¹¶æ‰§è¡Œ <code>eval</code> çœ‹çœ‹ä¼šä¸ä¼šæœ‰é—®é¢˜ã€‚</p>

<p>åœ¨ <code>eval_pod.rb</code> æ–‡ä»¶çš„æœ€ä¸‹é¢åŠ å…¥è¿™å‡ è¡Œä»£ç ï¼š</p>

<pre><code class="language-ruby">content = File.read './Podfile'
eval content
p $hash_value
</code></pre>

<p>è¿™é‡Œè¯»å–äº† Podfile æ–‡ä»¶ä¸­çš„å†…å®¹ï¼Œå¹¶æŠŠå…¶ä¸­çš„å†…å®¹å½“åšå­—ç¬¦ä¸²æ‰§è¡Œï¼Œæœ€åæ‰“å° <code>hash_value</code> çš„å€¼ã€‚</p>

<pre><code class="language-bash">$ ruby eval_pod.rb
</code></pre>

<p>è¿è¡Œè¿™æ®µ Ruby ä»£ç è™½ç„¶å¹¶æ²¡æœ‰ä»€ä¹ˆè¾“å‡ºï¼Œä½†æ˜¯å¹¶æ²¡æœ‰æŠ¥å‡ºä»»ä½•çš„é”™è¯¯ï¼Œæ¥ä¸‹æ¥æˆ‘ä»¬å°±å¯ä»¥å®Œå–„è¿™äº›æ–¹æ³•äº†ï¼š</p>

<pre><code class="language-ruby">def source(url)
    $hash_value['source'] = url
end

def target(target)
    targets = $hash_value['targets']
    targets = [] if targets == nil
    targets &lt;&lt; target
    $hash_value['targets'] = targets
    yield if block_given?
end

def platform(platform, version)
end

def pod(pod)
    pods = $hash_value['pods']
    pods = [] if pods == nil
    pods &lt;&lt; pod
    $hash_value['pods'] = pods
end
</code></pre>

<p>åœ¨æ·»åŠ äº†è¿™äº›æ–¹æ³•çš„å®ç°ä¹‹åï¼Œå†æ¬¡è¿è¡Œè„šæœ¬å°±ä¼šå¾—åˆ° Podfile ä¸­çš„ä¾èµ–ä¿¡æ¯äº†ï¼Œä¸è¿‡è¿™é‡Œçš„å®ç°éå¸¸ç®€å•çš„ï¼Œå¾ˆå¤šæƒ…å†µéƒ½æ²¡æœ‰å¤„ç†ï¼š</p>

<pre><code class="language-bash">$ ruby eval_pod.rb
{"source"=&gt;"http://source.git", "targets"=&gt;["Demo"], "pods"=&gt;["AFNetworking", "SDWebImage", "Masonry", "Typeset", "BlocksKit", "Mantle", "IQKeyboardManager", "IQDropDownTextField"]}
</code></pre>

<p>ä¸è¿‡ä½¿ç”¨ Ruby æ„å»ºä¸€ä¸ªåµŒå…¥å¼ DSL çš„è¿‡ç¨‹å¤§æ¦‚å°±æ˜¯è¿™æ ·ï¼Œä½¿ç”¨è¯­è¨€å†…å»ºçš„ç‰¹æ€§æ¥è¿›è¡Œåˆ›ä½œï¼Œåˆ›é€ å‡ºä¸€ä¸ªåœ¨ä½¿ç”¨æ—¶çœ‹èµ·æ¥å¹¶ä¸åƒä»£ç çš„ DSLã€‚</p>

<h2 id="å†™åœ¨åé¢">å†™åœ¨åé¢</h2>

<p>åœ¨æœ€åï¼Œç¬”è€…æƒ³è¯´çš„æ˜¯ï¼Œå½“æˆ‘ä»¬åœ¨æŸä¸€ä¸ªé¢†åŸŸç»å¸¸éœ€è¦è§£å†³é‡å¤æ€§é—®é¢˜æ—¶ï¼Œå¯ä»¥è€ƒè™‘å®ç°ä¸€ä¸ª DSL ä¸“é—¨ç”¨æ¥è§£å†³è¿™äº›ç±»ä¼¼çš„é—®é¢˜ã€‚</p>

<p>è€Œä½¿ç”¨åµŒå…¥å¼ DSL æ¥è§£å†³è¿™äº›é—®é¢˜æ˜¯ä¸€ä¸ªéå¸¸å¥½çš„åŠæ³•ï¼Œæˆ‘ä»¬å¹¶ä¸éœ€è¦é‡æ–°å®ç°è§£é‡Šå™¨ï¼Œä¹Ÿå¯ä»¥åˆ©ç”¨å®¿ä¸»è¯­è¨€çš„æŠ½è±¡èƒ½åŠ›ã€‚</p>

<p>åŒæ—¶ï¼Œåœ¨åµŒå…¥å¼ DSL æ‰©å±•äº† DSL çš„èŒƒç•´ä¹‹åï¼Œä¸è¦çº ç»“äºæŸäº›ä¸œè¥¿åˆ°åº•æ˜¯æ¡†æ¶è¿˜æ˜¯é¢†åŸŸç‰¹å®šè¯­è¨€ï¼Œè¿™äº›éƒ½ä¸é‡è¦ï¼Œé‡è¦çš„æ˜¯ï¼Œåœ¨é‡åˆ°äº†æŸäº›é—®é¢˜æ—¶ï¼Œæˆ‘ä»¬èƒ½å¦è·³å‡ºæ¥ï¼Œä½¿ç”¨æ–‡ä¸­ä»‹ç»çš„æ–¹æ³•å‡è½»æˆ‘ä»¬çš„å·¥ä½œé‡ã€‚</p>

<h2 id="reference">Reference</h2>

<ul>
  <li><a href="No Silver Bulletâ€”Essence and Accidents of Software Engineering">No Silver Bulletâ€”Essence and Accidents of Software Engineering</a></li>
  <li><a href="https://en.wikipedia.org/wiki/Domain-specific_language">Domain-specific language</a></li>
  <li><a href="http://martinfowler.com/bliki/DomainSpecificLanguage.html">DomainSpecificLanguage</a></li>
  <li><a href="http://taligarsiel.com/Projects/howbrowserswork1.htm">How browsers work</a></li>
</ul>

<h2 id="å…¶å®ƒ">å…¶å®ƒ</h2>

<blockquote>
  <p>GitHub Repoï¼š<a href="https://github.com/nju520/iOS-Source-Code-Analyze">iOS-Source-Code-Analyze</a></p>

</blockquote>

<blockquote>

  <p>Source: http://nju520.me/dsl</p>
</blockquote>

  ]]></description>
</item>

<item>
  <title>CocoaPods éƒ½åšäº†ä»€ä¹ˆï¼Ÿ</title>
  <link>//cocoapods</link>
  <author>nju520</author>
  <pubDate>2016-09-26T14:19:06+08:00</pubDate>
  <guid>//cocoapods</guid>
  <description><![CDATA[
  <p>ç¨æœ‰ iOS å¼€å‘ç»éªŒçš„äººåº”è¯¥éƒ½æ˜¯ç”¨è¿‡ CocoaPodsï¼Œè€Œå¯¹äº CIã€CD æœ‰äº†è§£çš„åŒå­¦ä¹Ÿéƒ½çŸ¥é“ Fastlaneã€‚è€Œè¿™ä¸¤ä¸ªåœ¨ iOS å¼€å‘ä¸­éå¸¸ä¾¿æ·çš„ç¬¬ä¸‰æ–¹åº“éƒ½æ˜¯ä½¿ç”¨ Ruby æ¥ç¼–å†™çš„ï¼Œè¿™æ˜¯ä¸ºä»€ä¹ˆï¼Ÿ</p>

<p>å…ˆæŠ›å¼€è¿™ä¸ªè¯é¢˜ä¸è°ˆï¼Œæˆ‘ä»¬æ¥çœ‹ä¸€ä¸‹ CocoaPods å’Œ Fastlane æ˜¯å¦‚ä½•ä½¿ç”¨çš„ï¼Œé¦–å…ˆæ˜¯ CocoaPodsï¼Œåœ¨æ¯ä¸€ä¸ªå·¥ç¨‹ä½¿ç”¨ CocoaPods çš„å·¥ç¨‹ä¸­éƒ½æœ‰ä¸€ä¸ª Podfileï¼š</p>

<pre><code class="language-ruby">source 'https://github.com/CocoaPods/Specs.git'

target 'Demo' do
	pod 'Mantle', '~&gt; 1.5.1'
	pod 'SDWebImage', '~&gt; 3.7.1'
	pod 'BlocksKit', '~&gt; 2.2.5'
	pod 'SSKeychain', '~&gt; 1.2.3'
	pod 'UMengAnalytics', '~&gt; 3.1.8'
	pod 'UMengFeedback', '~&gt; 1.4.2'
	pod 'Masonry', '~&gt; 0.5.3'
	pod 'AFNetworking', '~&gt; 2.4.1'
	pod 'Aspects', '~&gt; 1.4.1'
end
</code></pre>

<p>è¿™æ˜¯ä¸€ä¸ªä½¿ç”¨ Podfile å®šä¹‰ä¾èµ–çš„ä¸€ä¸ªä¾‹å­ï¼Œä¸è¿‡ Podfile å¯¹çº¦æŸçš„æè¿°å…¶å®æ˜¯è¿™æ ·çš„ï¼š</p>

<pre><code class="language-ruby">source('https://github.com/CocoaPods/Specs.git')

target('Demo') do
	pod('Mantle', '~&gt; 1.5.1')
	...
end
</code></pre>

<blockquote>
  <p>Ruby ä»£ç åœ¨è°ƒç”¨æ–¹æ³•æ—¶å¯ä»¥çœç•¥æ‹¬å·ã€‚</p>
</blockquote>

<p>Podfile ä¸­å¯¹äºçº¦æŸçš„æè¿°ï¼Œå…¶å®éƒ½å¯ä»¥çœ‹ä½œæ˜¯å¯¹ä»£ç ç®€å†™ï¼Œä¸Šé¢çš„ä»£ç åœ¨è§£ææ—¶å¯ä»¥å½“åš Ruby ä»£ç æ¥æ‰§è¡Œã€‚</p>

<p>Fastlane ä¸­çš„ä»£ç  Fastfile ä¹Ÿæ˜¯ç±»ä¼¼çš„ï¼š</p>

<pre><code class="language-ruby">lane :beta do
  increment_build_number
  cocoapods
  match
  testflight
  sh "./customScript.sh"
  slack
end
</code></pre>

<p>ä½¿ç”¨æè¿°æ€§çš„â€ä»£ç â€œç¼–å†™è„šæœ¬ï¼Œå¦‚æœæ²¡æœ‰æ¥è§¦æˆ–è€…ä½¿ç”¨è¿‡ Ruby çš„äººå¾ˆéš¾ç›¸ä¿¡ä¸Šé¢çš„è¿™äº›æ–‡æœ¬æ˜¯ä»£ç çš„ã€‚</p>

<h2 id="ruby-æ¦‚è¿°">Ruby æ¦‚è¿°</h2>

<p>åœ¨ä»‹ç» CocoaPods çš„å®ç°ä¹‹å‰ï¼Œæˆ‘ä»¬éœ€è¦å¯¹ Ruby çš„ä¸€äº›ç‰¹æ€§æœ‰ä¸€ä¸ªç®€å•çš„äº†è§£ï¼Œåœ¨å‘èº«è¾¹çš„æœ‹å‹â€œä¼ æ•™â€çš„æ—¶å€™ï¼Œæˆ‘å¾€å¾€éƒ½ä¼šç”¨ä¼˜é›…è¿™ä¸ªè¯æ¥å½¢å®¹è¿™é—¨è¯­è¨€<del>ï¼ˆæ‰‹åŠ¨å¾®ç¬‘ï¼‰</del>ã€‚</p>

<p>é™¤äº†ä¼˜é›…ä¹‹å¤–ï¼ŒRuby çš„è¯­æ³•å…·æœ‰å¼ºå¤§çš„è¡¨ç°åŠ›ï¼Œå¹¶ä¸”å…¶ä½¿ç”¨éå¸¸çµæ´»ï¼Œèƒ½å¿«é€Ÿå®ç°æˆ‘ä»¬çš„éœ€æ±‚ï¼Œè¿™é‡Œç®€å•ä»‹ç»ä¸€ä¸‹ Ruby ä¸­çš„ä¸€äº›ç‰¹æ€§ã€‚</p>

<h3 id="ä¸€åˆ‡çš†å¯¹è±¡">ä¸€åˆ‡çš†å¯¹è±¡</h3>

<p>åœ¨è®¸å¤šè¯­è¨€ï¼Œæ¯”å¦‚ Java ä¸­ï¼Œæ•°å­—ä¸å…¶ä»–çš„åŸºæœ¬ç±»å‹éƒ½ä¸æ˜¯å¯¹è±¡ï¼Œè€Œåœ¨ Ruby ä¸­æ‰€æœ‰çš„å…ƒç´ ï¼ŒåŒ…æ‹¬åŸºæœ¬ç±»å‹éƒ½æ˜¯å¯¹è±¡ï¼ŒåŒæ—¶ä¹Ÿä¸å­˜åœ¨è¿ç®—ç¬¦çš„æ¦‚å¿µï¼Œæ‰€è°“çš„ <code>1 + 1</code>ï¼Œå…¶å®åªæ˜¯ <code>1.+(1)</code> çš„è¯­æ³•ç³–è€Œå·²ã€‚</p>

<p>å¾—ç›Šäºä¸€åˆ‡çš†å¯¹è±¡çš„æ¦‚å¿µï¼Œåœ¨ Ruby ä¸­ï¼Œä½ å¯ä»¥å‘ä»»æ„çš„å¯¹è±¡å‘é€ <code>methods</code> æ¶ˆæ¯ï¼Œåœ¨è¿è¡Œæ—¶è‡ªçœï¼Œæ‰€ä»¥ç¬”è€…åœ¨æ¯æ¬¡å¿˜è®°æ–¹æ³•æ—¶ï¼Œéƒ½ä¼šç›´æ¥ç”¨ <code>methods</code> æ¥â€œæŸ¥æ–‡æ¡£â€ï¼š</p>

<pre><code class="language-ruby">2.3.1 :003 &gt; 1.methods
 =&gt; [:%, :&amp;, :*, :+, :-, :/, :&lt;, :&gt;, :^, :|, :~, :-@, :**, :&lt;=&gt;, :&lt;&lt;, :&gt;&gt;, :&lt;=, :&gt;=, :==, :===, :[], :inspect, :size, :succ, :to_s, :to_f, :div, :divmod, :fdiv, :modulo, :abs, :magnitude, :zero?, :odd?, :even?, :bit_length, :to_int, :to_i, :next, :upto, :chr, :ord, :integer?, :floor, :ceil, :round, :truncate, :downto, :times, :pred, :to_r, :numerator, :denominator, :rationalize, :gcd, :lcm, :gcdlcm, :+@, :eql?, :singleton_method_added, :coerce, :i, :remainder, :real?, :nonzero?, :step, :positive?, :negative?, :quo, :arg, :rectangular, :rect, :polar, :real, :imaginary, :imag, :abs2, :angle, :phase, :conjugate, :conj, :to_c, :between?, :instance_of?, :public_send, :instance_variable_get, :instance_variable_set, :instance_variable_defined?, :remove_instance_variable, :private_methods, :kind_of?, :instance_variables, :tap, :is_a?, :extend, :define_singleton_method, :to_enum, :enum_for, :=~, :!~, :respond_to?, :freeze, :display, :send, :object_id, :method, :public_method, :singleton_method, :nil?, :hash, :class, :singleton_class, :clone, :dup, :itself, :taint, :tainted?, :untaint, :untrust, :trust, :untrusted?, :methods, :protected_methods, :frozen?, :public_methods, :singleton_methods, :!, :!=, :__send__, :equal?, :instance_eval, :instance_exec, :__id__]
</code></pre>

<p>æ¯”å¦‚åœ¨è¿™é‡Œå‘å¯¹è±¡ <code>1</code> è°ƒç”¨ <code>methods</code> å°±ä¼šè¿”å›å®ƒèƒ½å“åº”çš„æ‰€æœ‰æ–¹æ³•ã€‚</p>

<p>ä¸€åˆ‡çš†å¯¹è±¡ä¸ä»…å‡å°‘äº†è¯­è¨€ä¸­ç±»å‹çš„ä¸ä¸€è‡´ï¼Œæ¶ˆç­äº†åŸºæœ¬æ•°æ®ç±»å‹ä¸å¯¹è±¡ä¹‹é—´çš„è¾¹ç•Œï¼›è¿™ä¸€æ¦‚å¿µåŒæ—¶ä¹Ÿç®€åŒ–äº†è¯­è¨€ä¸­çš„ç»„æˆå…ƒç´ ï¼Œè¿™æ · Ruby ä¸­åªæœ‰å¯¹è±¡å’Œæ–¹æ³•ï¼Œè¿™ä¸¤ä¸ªæ¦‚å¿µï¼Œè¿™ä¹Ÿé™ä½äº†æˆ‘ä»¬ç†è§£è¿™é—¨è¯­è¨€çš„å¤æ‚åº¦ï¼š</p>

<ul>
  <li>ä½¿ç”¨å¯¹è±¡å­˜å‚¨çŠ¶æ€</li>
  <li>å¯¹è±¡ä¹‹é—´é€šè¿‡æ–¹æ³•é€šä¿¡</li>
</ul>

<h3 id="block">block</h3>

<p>Ruby å¯¹å‡½æ•°å¼ç¼–ç¨‹èŒƒå¼çš„æ”¯æŒæ˜¯é€šè¿‡ blockï¼Œè¿™é‡Œçš„ block å’Œ Objective-C ä¸­çš„ block æœ‰äº›ä¸åŒã€‚</p>

<p>é¦–å…ˆ Ruby ä¸­çš„ block ä¹Ÿæ˜¯ä¸€ç§å¯¹è±¡ï¼Œæ‰€æœ‰çš„ Block éƒ½æ˜¯ Proc ç±»çš„å®ä¾‹ï¼Œä¹Ÿå°±æ˜¯æ‰€æœ‰çš„ block éƒ½æ˜¯ first-class çš„ï¼Œå¯ä»¥ä½œä¸ºå‚æ•°ä¼ é€’ï¼Œè¿”å›ã€‚</p>

<pre><code class="language-ruby">def twice(&amp;proc)
	2.times { proc.call() } if proc
end

def twice
	2.times { yield } if block_given?
end
</code></pre>

<blockquote>
  <p><code>yield</code> ä¼šè°ƒç”¨å¤–éƒ¨ä¼ å…¥çš„ blockï¼Œ<code>block_given?</code> ç”¨äºåˆ¤æ–­å½“å‰æ–¹æ³•æ˜¯å¦ä¼ å…¥äº† <code>block</code>ã€‚</p>
</blockquote>

<p>åœ¨è¿™ä¸ªæ–¹æ³•è°ƒç”¨æ—¶ï¼Œæ˜¯è¿™æ ·çš„ï¼š</p>

<pre><code class="language-ruby">twice do
	puts "Hello"
end
</code></pre>

<h3 id="eval">eval</h3>

<p>æœ€åä¸€ä¸ªéœ€è¦ä»‹ç»çš„ç‰¹æ€§å°±æ˜¯ <code>eval</code> äº†ï¼Œæ—©åœ¨å‡ åå¹´å‰çš„ Lisp è¯­è¨€å°±æœ‰äº† <code>eval</code> è¿™ä¸ªæ–¹æ³•ï¼Œè¿™ä¸ªæ–¹æ³•ä¼šå°†å­—ç¬¦ä¸²å½“åšä»£ç æ¥æ‰§è¡Œï¼Œä¹Ÿå°±æ˜¯è¯´ <code>eval</code> æ¨¡ç³Šäº†ä»£ç ä¸æ•°æ®ä¹‹é—´çš„è¾¹ç•Œã€‚</p>

<pre><code class="language-ruby">&gt; eval "1 + 2 * 3"
 =&gt; 7
</code></pre>

<p>æœ‰äº† <code>eval</code> æ–¹æ³•ï¼Œæˆ‘ä»¬å°±è·å¾—äº†æ›´åŠ å¼ºå¤§çš„åŠ¨æ€èƒ½åŠ›ï¼Œåœ¨è¿è¡Œæ—¶ï¼Œä½¿ç”¨å­—ç¬¦ä¸²æ¥æ”¹å˜æ§åˆ¶æµç¨‹ï¼Œæ‰§è¡Œä»£ç ï¼›è€Œä¸éœ€è¦å»æ‰‹åŠ¨è§£æè¾“å…¥ã€ç”Ÿæˆè¯­æ³•æ ‘ã€‚</p>

<h3 id="æ‰‹åŠ¨è§£æ-podfile">æ‰‹åŠ¨è§£æ Podfile</h3>

<p>åœ¨æˆ‘ä»¬å¯¹ Ruby è¿™é—¨è¯­è¨€æœ‰äº†ä¸€ä¸ªç®€å•çš„äº†è§£ä¹‹åï¼Œå°±å¯ä»¥å¼€å§‹å†™ä¸€ä¸ªç®€æ˜“çš„è§£æ Podfile çš„è„šæœ¬äº†ã€‚</p>

<p>åœ¨è¿™é‡Œï¼Œæˆ‘ä»¬ä»¥ä¸€ä¸ªéå¸¸ç®€å•çš„ Podfile ä¸ºä¾‹ï¼Œä½¿ç”¨ Ruby è„šæœ¬è§£æ Podfile ä¸­æŒ‡å®šçš„ä¾èµ–ï¼š</p>

<pre><code class="language-ruby">source 'http://source.git'
platform :ios, '8.0'

target 'Demo' do
    pod 'AFNetworking'
    pod 'SDWebImage'
    pod 'Masonry'
    pod "Typeset"
    pod 'BlocksKit'
    pod 'Mantle'
    pod 'IQKeyboardManager'
    pod 'IQDropDownTextField'
end
</code></pre>

<p>å› ä¸ºè¿™é‡Œçš„ <code>source</code>ã€<code>platform</code>ã€<code>target</code> ä»¥åŠ <code>pod</code> éƒ½æ˜¯æ–¹æ³•ï¼Œæ‰€ä»¥åœ¨è¿™é‡Œæˆ‘ä»¬éœ€è¦æ„å»ºä¸€ä¸ªåŒ…å«ä¸Šè¿°æ–¹æ³•çš„ä¸Šä¸‹æ–‡ï¼š</p>

<pre><code class="language-ruby"># eval_pod.rb
$hash_value = {}

def source(url)
end

def target(target)
end

def platform(platform, version)
end

def pod(pod)
end
</code></pre>

<p>ä½¿ç”¨ä¸€ä¸ªå…¨å±€å˜é‡ <code>hash_value</code> å­˜å‚¨ Podfile ä¸­æŒ‡å®šçš„ä¾èµ–ï¼Œå¹¶ä¸”æ„å»ºäº†ä¸€ä¸ª Podfile è§£æè„šæœ¬çš„éª¨æ¶ï¼›æˆ‘ä»¬å…ˆä¸å»å®Œå–„è¿™äº›æ–¹æ³•çš„å®ç°ç»†èŠ‚ï¼Œå…ˆå°è¯•ä¸€ä¸‹è¯»å– Podfile ä¸­çš„å†…å®¹å¹¶æ‰§è¡Œä¼šä¸ä¼šæœ‰ä»€ä¹ˆé—®é¢˜ã€‚</p>

<p>åœ¨ <code>eval_pod.rb</code> æ–‡ä»¶çš„æœ€ä¸‹é¢åŠ å…¥è¿™å‡ è¡Œä»£ç ï¼š</p>

<pre><code class="language-ruby">content = File.read './Podfile'
eval content
p $hash_value
</code></pre>

<p>è¿™é‡Œè¯»å–äº† Podfile æ–‡ä»¶ä¸­çš„å†…å®¹ï¼Œå¹¶æŠŠå…¶ä¸­çš„å†…å®¹å½“åšå­—ç¬¦ä¸²æ‰§è¡Œï¼Œæœ€åæ‰“å° <code>hash_value</code> çš„å€¼ã€‚</p>

<pre><code class="language-ruby">$ ruby eval_pod.rb
</code></pre>

<p>è¿è¡Œè¿™æ®µ Ruby ä»£ç è™½ç„¶å¹¶æ²¡æœ‰ä»€ä¹ˆè¾“å‡ºï¼Œä½†æ˜¯å¹¶æ²¡æœ‰æŠ¥å‡ºä»»ä½•çš„é”™è¯¯ï¼Œæ¥ä¸‹æ¥æˆ‘ä»¬å°±å¯ä»¥å®Œå–„è¿™äº›æ–¹æ³•äº†ï¼š</p>

<pre><code class="language-ruby">def source(url)
    $hash_value['source'] = url
end

def target(target)
    targets = $hash_value['targets']
    targets = [] if targets == nil
    targets &lt;&lt; target
    $hash_value['targets'] = targets
    yield if block_given?
end

def platform(platform, version)
end

def pod(pod)
    pods = $hash_value['pods']
    pods = [] if pods == nil
    pods &lt;&lt; pod
    $hash_value['pods'] = pods
end
</code></pre>

<p>åœ¨æ·»åŠ äº†è¿™äº›æ–¹æ³•çš„å®ç°ä¹‹åï¼Œå†æ¬¡è¿è¡Œè„šæœ¬å°±ä¼šå¾—åˆ° Podfile ä¸­çš„ä¾èµ–ä¿¡æ¯äº†ï¼Œä¸è¿‡è¿™é‡Œçš„å®ç°éå¸¸ç®€å•çš„ï¼Œå¾ˆå¤šæƒ…å†µéƒ½æ²¡æœ‰å¤„ç†ï¼š</p>

<pre><code class="language-ruby">$ ruby eval_pod.rb
{"source"=&gt;"http://source.git", "targets"=&gt;["Demo"], "pods"=&gt;["AFNetworking", "SDWebImage", "Masonry", "Typeset", "BlocksKit", "Mantle", "IQKeyboardManager", "IQDropDownTextField"]}
</code></pre>

<p>CocoaPods ä¸­å¯¹äº Podfile çš„è§£æä¸è¿™é‡Œçš„å®ç°å…¶å®å·®ä¸å¤šï¼Œæ¥ä¸‹æ¥å°±è¿›å…¥äº† CocoaPods çš„å®ç°éƒ¨åˆ†äº†ã€‚</p>

<h2 id="cocoapods-çš„å®ç°">CocoaPods çš„å®ç°</h2>

<p>åœ¨ä¸Šé¢ç®€å•ä»‹ç»äº† Ruby çš„ä¸€äº›è¯­æ³•ä»¥åŠå¦‚ä½•è§£æ Podfile ä¹‹åï¼Œæˆ‘ä»¬å¼€å§‹æ·±å…¥äº†è§£ä¸€ä¸‹ CocoaPods æ˜¯å¦‚ä½•ç®¡ç† iOS é¡¹ç›®çš„ä¾èµ–ï¼Œä¹Ÿå°±æ˜¯ <code>pod install</code> åˆ°åº•åšäº†äº›ä»€ä¹ˆã€‚</p>

<h3 id="pod-install-çš„è¿‡ç¨‹">Pod install çš„è¿‡ç¨‹</h3>

<p><code>pod install</code> è¿™ä¸ªå‘½ä»¤åˆ°åº•åšäº†ä»€ä¹ˆï¼Ÿé¦–å…ˆï¼Œåœ¨ CocoaPods ä¸­ï¼Œæ‰€æœ‰çš„å‘½ä»¤éƒ½ä¼šç”± <code>Command</code> ç±»æ´¾å‘åˆ°å°†å¯¹åº”çš„ç±»ï¼Œè€ŒçœŸæ­£æ‰§è¡Œ <code>pod install</code> çš„ç±»å°±æ˜¯ <code>Install</code>ï¼š</p>

<pre><code class="language-ruby">module Pod
  class Command
	class Install &lt; Command
	  def run
		verify_podfile_exists!
		installer = installer_for_config
		installer.repo_update = repo_update?(:default =&gt; false)
		installer.update = false
		installer.install!
	  end
	end
  end
end
</code></pre>

<p>è¿™é‡Œé¢ä¼šä»é…ç½®ç±»çš„å®ä¾‹ <code>config</code> ä¸­è·å–ä¸€ä¸ª <code>Installer</code> çš„å®ä¾‹ï¼Œç„¶åæ‰§è¡Œ <code>install!</code> æ–¹æ³•ï¼Œè¿™é‡Œçš„ <code>installer</code> æœ‰ä¸€ä¸ª <code>update</code> å±æ€§ï¼Œè€Œè¿™ä¹Ÿå°±æ˜¯ <code>pod install</code> å’Œ <code>update</code> ä¹‹é—´æœ€å¤§çš„åŒºåˆ«ï¼Œ<strong>å…¶ä¸­åè€…ä¼šæ— è§†å·²æœ‰çš„ Podfile.lock æ–‡ä»¶ï¼Œé‡æ–°å¯¹ä¾èµ–è¿›è¡Œåˆ†æ</strong>ï¼š</p>

<pre><code class="language-ruby">module Pod
  class Command
	class Update &lt; Command
	  def run
		...

		installer = installer_for_config
		installer.repo_update = repo_update?(:default =&gt; true)
		installer.update = true
		installer.install!
	  end
	end
  end
end
</code></pre>

<h3 id="podfile-çš„è§£æ">Podfile çš„è§£æ</h3>

<p>Podfile ä¸­ä¾èµ–çš„è§£æå…¶å®æ˜¯ä¸æˆ‘ä»¬åœ¨æ‰‹åŠ¨è§£æ Podfile ç« èŠ‚æ‰€ä»‹ç»çš„å·®ä¸å¤šï¼Œæ•´ä¸ªè¿‡ç¨‹ä¸»è¦éƒ½æ˜¯ç”± <strong>CocoaPods-Core</strong> è¿™ä¸ªæ¨¡å—æ¥å®Œæˆçš„ï¼Œè€Œè¿™ä¸ªè¿‡ç¨‹æ—©åœ¨ <code>installer_for_config</code> ä¸­å°±å·²ç»å¼€å§‹äº†ï¼š</p>

<pre><code class="language-ruby">def installer_for_config
  Installer.new(config.sandbox, config.podfile, config.lockfile)
end
</code></pre>

<p>è¿™ä¸ªæ–¹æ³•ä¼šä» <code>config.podfile</code> ä¸­å–å‡ºä¸€ä¸ª <code>Podfile</code> ç±»çš„å®ä¾‹ï¼š</p>

<pre><code class="language-ruby">def podfile
  @podfile ||= Podfile.from_file(podfile_path) if podfile_path
end
</code></pre>

<p>ç±»æ–¹æ³• <code>Podfile.from_file</code> å°±å®šä¹‰åœ¨ CocoaPods-Core è¿™ä¸ªåº“ä¸­ï¼Œç”¨äºåˆ†æ Podfile ä¸­å®šä¹‰çš„ä¾èµ–ï¼Œè¿™ä¸ªæ–¹æ³•ä¼šæ ¹æ® Podfile ä¸åŒçš„ç±»å‹é€‰æ‹©ä¸åŒçš„è°ƒç”¨è·¯å¾„ï¼š</p>

<pre><code class="language-ruby">Podfile.from_file
`-- Podfile.from_ruby
	|-- File.open
	`-- eval
</code></pre>

<p><code>from_ruby</code> ç±»æ–¹æ³•å°±ä¼šåƒæˆ‘ä»¬åœ¨å‰é¢åšçš„è§£æ Podfile çš„æ–¹æ³•ä¸€æ ·ï¼Œä»æ–‡ä»¶ä¸­è¯»å–æ•°æ®ï¼Œç„¶åä½¿ç”¨ <code>eval</code> ç›´æ¥å°†æ–‡ä»¶ä¸­çš„å†…å®¹å½“åš Ruby ä»£ç æ¥æ‰§è¡Œã€‚</p>

<pre><code class="language-ruby">def self.from_ruby(path, contents = nil)
  contents ||= File.open(path, 'r:utf-8', &amp;:read)

  podfile = Podfile.new(path) do
	begin
	  eval(contents, nil, path.to_s)
	rescue Exception =&gt; e
	  message = "Invalid `#{path.basename}` file: #{e.message}"
	  raise DSLError.new(message, path, e, contents)
	end
  end
  podfile
end
</code></pre>

<p>åœ¨ Podfile è¿™ä¸ªç±»çš„é¡¶éƒ¨ï¼Œæˆ‘ä»¬ä½¿ç”¨ Ruby çš„ <code>Mixin</code> çš„è¯­æ³•æ¥æ··å…¥ Podfile ä¸­ä»£ç æ‰§è¡Œæ‰€éœ€è¦çš„ä¸Šä¸‹æ–‡ï¼š</p>

<pre><code class="language-ruby">include Pod::Podfile::DSL
</code></pre>

<p>Podfile ä¸­çš„æ‰€æœ‰ä½ è§åˆ°çš„æ–¹æ³•éƒ½æ˜¯å®šä¹‰åœ¨ <code>DSL</code> è¿™ä¸ªæ¨¡å—ä¸‹é¢çš„ï¼š</p>

<pre><code class="language-ruby">module Pod
  class Podfile
	module DSL
	  def pod(name = nil, *requirements) end
	  def target(name, options = nil) end
	  def platform(name, target = nil) end
	  def inhibit_all_warnings! end
	  def use_frameworks!(flag = true) end
	  def source(source) end
	  ...
	end
  end
end
</code></pre>

<p>è¿™é‡Œå®šä¹‰äº†å¾ˆå¤š Podfile ä¸­ä½¿ç”¨çš„æ–¹æ³•ï¼Œå½“ä½¿ç”¨ <code>eval</code> æ‰§è¡Œæ–‡ä»¶ä¸­çš„ä»£ç æ—¶ï¼Œå°±ä¼šæ‰§è¡Œè¿™ä¸ªæ¨¡å—é‡Œçš„æ–¹æ³•ï¼Œåœ¨è¿™é‡Œç®€å•çœ‹ä¸€ä¸‹å…¶ä¸­å‡ ä¸ªæ–¹æ³•çš„å®ç°ï¼Œæ¯”å¦‚è¯´ <code>source</code> æ–¹æ³•ï¼š</p>

<pre><code class="language-ruby">def source(source)
  hash_sources = get_hash_value('sources') || []
  hash_sources &lt;&lt; source
  set_hash_value('sources', hash_sources.uniq)
end
</code></pre>

<p>è¯¥æ–¹æ³•ä¼šå°†æ–°çš„ <code>source</code> åŠ å…¥å·²æœ‰çš„æºæ•°ç»„ä¸­ï¼Œç„¶åæ›´æ–°åŸæœ‰çš„ <code>sources</code> å¯¹åº”çš„å€¼ã€‚</p>

<p>ç¨å¾®å¤æ‚ä¸€äº›çš„æ˜¯ <code>target</code> æ–¹æ³•ï¼š</p>

<pre><code class="language-ruby">def target(name, options = nil)
  if options
	raise Informative, "Unsupported options `#{options}` for " \
	  "target `#{name}`."
  end

  parent = current_target_definition
  definition = TargetDefinition.new(name, parent)
  self.current_target_definition = definition
  yield if block_given?
ensure
  self.current_target_definition = parent
end
</code></pre>

<p>è¿™ä¸ªæ–¹æ³•ä¼šåˆ›å»ºä¸€ä¸ª <code>TargetDefinition</code> ç±»çš„å®ä¾‹ï¼Œç„¶åå°†å½“å‰ç¯å¢ƒç³»çš„ <code>target_definition</code> è®¾ç½®æˆè¿™ä¸ªåˆšåˆšåˆ›å»ºçš„å®ä¾‹ã€‚è¿™æ ·ï¼Œä¹‹åä½¿ç”¨ <code>pod</code> å®šä¹‰çš„ä¾èµ–éƒ½ä¼šå¡«å……åˆ°å½“å‰çš„ <code>TargetDefinition</code> ä¸­ï¼š</p>

<pre><code class="language-ruby">def pod(name = nil, *requirements)
  unless name
	raise StandardError, 'A dependency requires a name.'
  end

  current_target_definition.store_pod(name, *requirements)
end
</code></pre>

<p>å½“ <code>pod</code> æ–¹æ³•è¢«è°ƒç”¨æ—¶ï¼Œä¼šæ‰§è¡Œ <code>store_pod</code> å°†ä¾èµ–å­˜å‚¨åˆ°å½“å‰ <code>target</code> ä¸­çš„ <code>dependencies</code> æ•°ç»„ä¸­ï¼š</p>

<pre><code class="language-ruby">def store_pod(name, *requirements)
  return if parse_subspecs(name, requirements)
  parse_inhibit_warnings(name, requirements)
  parse_configuration_whitelist(name, requirements)

  if requirements &amp;&amp; !requirements.empty?
	pod = { name =&gt; requirements }
  else
	pod = name
  end

  get_hash_value('dependencies', []) &lt;&lt; pod
  nil
end
</code></pre>

<p>æ€»ç»“ä¸€ä¸‹ï¼ŒCocoaPods å¯¹ Podfile çš„è§£æä¸æˆ‘ä»¬åœ¨å‰é¢åšçš„æ‰‹åŠ¨è§£æ Podfile çš„åŸç†å·®ä¸å¤šï¼Œæ„å»ºä¸€ä¸ªåŒ…å«ä¸€äº›æ–¹æ³•çš„ä¸Šä¸‹æ–‡ï¼Œç„¶åç›´æ¥æ‰§è¡Œ <code>eval</code> æ–¹æ³•å°†æ–‡ä»¶çš„å†…å®¹å½“åšä»£ç æ¥æ‰§è¡Œï¼Œè¿™æ ·åªè¦ Podfile ä¸­çš„æ•°æ®æ˜¯ç¬¦åˆè§„èŒƒçš„ï¼Œé‚£ä¹ˆè§£æ Podfile å°±æ˜¯éå¸¸ç®€å•å®¹æ˜“çš„ã€‚</p>

<h3 id="å®‰è£…ä¾èµ–çš„è¿‡ç¨‹">å®‰è£…ä¾èµ–çš„è¿‡ç¨‹</h3>

<p>Podfile è¢«è§£æåçš„å†…å®¹ä¼šè¢«è½¬åŒ–æˆä¸€ä¸ª <code>Podfile</code> ç±»çš„å®ä¾‹ï¼Œè€Œ <code>Installer</code> çš„å®ä¾‹æ–¹æ³• <code>install!</code> å°±ä¼šä½¿ç”¨è¿™äº›ä¿¡æ¯å®‰è£…å½“å‰å·¥ç¨‹çš„ä¾èµ–ï¼Œè€Œæ•´ä¸ªå®‰è£…ä¾èµ–çš„è¿‡ç¨‹å¤§çº¦æœ‰å››ä¸ªéƒ¨åˆ†ï¼š</p>

<ul>
  <li>è§£æ Podfile ä¸­çš„ä¾èµ–</li>
  <li>ä¸‹è½½ä¾èµ–</li>
  <li>åˆ›å»º <code>Pods.xcodeproj</code> å·¥ç¨‹</li>
  <li>é›†æˆ workspace</li>
</ul>

<pre><code class="language-ruby">def install!
  resolve_dependencies
  download_dependencies
  generate_pods_project
  integrate_user_project
end
</code></pre>

<p>åœ¨ä¸Šé¢çš„ <code>install</code> æ–¹æ³•è°ƒç”¨çš„ <code>resolve_dependencies</code> ä¼šåˆ›å»ºä¸€ä¸ª <code>Analyzer</code> ç±»çš„å®ä¾‹ï¼Œåœ¨è¿™ä¸ªæ–¹æ³•ä¸­ï¼Œä½ ä¼šçœ‹åˆ°ä¸€äº›éå¸¸ç†Ÿæ‚‰çš„å­—ç¬¦ä¸²ï¼š</p>

<pre><code class="language-ruby">def resolve_dependencies
  analyzer = create_analyzer

  plugin_sources = run_source_provider_hooks
  analyzer.sources.insert(0, *plugin_sources)

  UI.section 'Updating local specs repositories' do
	analyzer.update_repositories
  end if repo_update?

  UI.section 'Analyzing dependencies' do
	analyze(analyzer)
	validate_build_configurations
	clean_sandbox
  end
end
</code></pre>

<p>åœ¨ä½¿ç”¨ CocoaPods ä¸­ç»å¸¸å‡ºç°çš„ <code>Updating local specs repositories</code> ä»¥åŠ <code>Analyzing dependencies</code> å°±æ˜¯ä»è¿™é‡Œè¾“å‡ºåˆ°ç»ˆç«¯çš„ï¼Œè¯¥æ–¹æ³•ä¸ä»…è´Ÿè´£å¯¹æœ¬åœ°æ‰€æœ‰ PodSpec æ–‡ä»¶çš„æ›´æ–°ï¼Œè¿˜ä¼šå¯¹å½“å‰ <code>Podfile</code> ä¸­çš„ä¾èµ–è¿›è¡Œåˆ†æï¼š</p>

<pre><code class="language-ruby">def analyze(analyzer = create_analyzer)
  analyzer.update = update
  @analysis_result = analyzer.analyze
  @aggregate_targets = analyzer.result.targets
end
</code></pre>

<p><code>analyzer.analyze</code> æ–¹æ³•æœ€ç»ˆä¼šè°ƒç”¨ <code>Resolver</code> çš„å®ä¾‹æ–¹æ³• <code>resolve</code>ï¼š</p>

<pre><code class="language-ruby">def resolve
  dependencies = podfile.target_definition_list.flat_map do |target|
	target.dependencies.each do |dep|
	  @platforms_by_dependency[dep].push(target.platform).uniq! if target.platform
	end
  end
  @activated = Molinillo::Resolver.new(self, self).resolve(dependencies, locked_dependencies)
  specs_by_target
rescue Molinillo::ResolverError =&gt; e
  handle_resolver_error(e)
end
</code></pre>

<p>è¿™é‡Œçš„ <code>Molinillo::Resolver</code> å°±æ˜¯ç”¨äºè§£å†³ä¾èµ–å…³ç³»çš„ç±»ã€‚</p>

<h4 id="è§£å†³ä¾èµ–å…³ç³»resolve-dependencies">è§£å†³ä¾èµ–å…³ç³»ï¼ˆResolve Dependenciesï¼‰</h4>

<p>CocoaPods ä¸ºäº†è§£å†³ Podfile ä¸­å£°æ˜çš„ä¾èµ–å…³ç³»ï¼Œä½¿ç”¨äº†ä¸€ä¸ªå«åš <a href="https://github.com/CocoaPods/Molinillo/blob/master/ARCHITECTURE.md">Milinillo</a> çš„ä¾èµ–å…³ç³»è§£å†³ç®—æ³•ï¼›ä½†æ˜¯ï¼Œç¬”è€…åœ¨ Google ä¸Šå¹¶æ²¡æœ‰æ‰¾åˆ°ä¸è¿™ä¸ªç®—æ³•ç›¸å…³çš„å…¶ä»–ä¿¡æ¯ï¼Œæ¨æµ‹æ˜¯ CocoaPods ä¸ºäº†è§£å†³ iOS ä¸­çš„ä¾èµ–å…³ç³»åˆ›é€ çš„ç®—æ³•ã€‚</p>

<p>Milinillo ç®—æ³•çš„æ ¸å¿ƒæ˜¯ <a href="https://en.wikipedia.org/wiki/Backtracking">å›æº¯ï¼ˆBacktrackingï¼‰</a> ä»¥åŠ <a href="https://en.wikipedia.org/wiki/Look-ahead_(backtracking)">å‘å‰æ£€æŸ¥ï¼ˆforward checkï¼‰</a>ï¼Œæ•´ä¸ªè¿‡ç¨‹ä¼šè¿½è¸ªæ ˆä¸­çš„ä¸¤ä¸ªçŠ¶æ€ï¼ˆä¾èµ–å’Œå¯èƒ½æ€§ï¼‰ã€‚</p>

<p>åœ¨è¿™é‡Œå¹¶ä¸æƒ³é™·å…¥å¯¹è¿™ä¸ªç®—æ³•æ‰§è¡Œè¿‡ç¨‹çš„åˆ†æä¹‹ä¸­ï¼Œå¦‚æœæœ‰å…´è¶£å¯ä»¥çœ‹ä¸€ä¸‹ä»“åº“ä¸­çš„ <a href="https://github.com/CocoaPods/Molinillo/blob/master/ARCHITECTURE.md">ARCHITECTURE.md</a> æ–‡ä»¶ï¼Œå…¶ä¸­æ¯”è¾ƒè¯¦ç»†çš„è§£é‡Šäº† Milinillo ç®—æ³•çš„å·¥ä½œåŸç†ï¼Œå¹¶å¯¹å…¶åŠŸèƒ½æ‰§è¡Œè¿‡ç¨‹æœ‰ä¸€ä¸ªæ¯”è¾ƒè¯¦ç»†çš„ä»‹ç»ã€‚</p>

<p><code>Molinillo::Resolver</code> æ–¹æ³•ä¼šè¿”å›ä¸€ä¸ªä¾èµ–å›¾ï¼Œå…¶å†…å®¹å¤§æ¦‚æ˜¯è¿™æ ·çš„ï¼š</p>

<pre><code class="language-ruby">Molinillo::DependencyGraph:[
	Molinillo::DependencyGraph::Vertex:AFNetworking(#&lt;Pod::Specification name="AFNetworking"&gt;),
	Molinillo::DependencyGraph::Vertex:SDWebImage(#&lt;Pod::Specification name="SDWebImage"&gt;),
	Molinillo::DependencyGraph::Vertex:Masonry(#&lt;Pod::Specification name="Masonry"&gt;),
	Molinillo::DependencyGraph::Vertex:Typeset(#&lt;Pod::Specification name="Typeset"&gt;),
	Molinillo::DependencyGraph::Vertex:CCTabBarController(#&lt;Pod::Specification name="CCTabBarController"&gt;),
	Molinillo::DependencyGraph::Vertex:BlocksKit(#&lt;Pod::Specification name="BlocksKit"&gt;),
	Molinillo::DependencyGraph::Vertex:Mantle(#&lt;Pod::Specification name="Mantle"&gt;),
	...
]
</code></pre>

<p>è¿™ä¸ªä¾èµ–å›¾æ˜¯ç”±ä¸€ä¸ªç»“ç‚¹æ•°ç»„ç»„æˆçš„ï¼Œåœ¨ CocoaPods æ‹¿åˆ°äº†è¿™ä¸ªä¾èµ–å›¾ä¹‹åï¼Œä¼šåœ¨ <code>specs_by_target</code> ä¸­æŒ‰ç…§ <code>Target</code> å°†æ‰€æœ‰çš„ <code>Specification</code> åˆ†ç»„ï¼š</p>

<pre><code class="language-ruby">{
	#&lt;Pod::Podfile::TargetDefinition label=Pods&gt;=&gt;[],
	#&lt;Pod::Podfile::TargetDefinition label=Pods-Demo&gt;=&gt;[
		#&lt;Pod::Specification name="AFNetworking"&gt;,
		#&lt;Pod::Specification name="AFNetworking/NSURLSession"&gt;,
		#&lt;Pod::Specification name="AFNetworking/Reachability"&gt;,
		#&lt;Pod::Specification name="AFNetworking/Security"&gt;,
		#&lt;Pod::Specification name="AFNetworking/Serialization"&gt;,
		#&lt;Pod::Specification name="AFNetworking/UIKit"&gt;,
		#&lt;Pod::Specification name="BlocksKit/Core"&gt;,
		#&lt;Pod::Specification name="BlocksKit/DynamicDelegate"&gt;,
		#&lt;Pod::Specification name="BlocksKit/MessageUI"&gt;,
		#&lt;Pod::Specification name="BlocksKit/UIKit"&gt;,
		#&lt;Pod::Specification name="CCTabBarController"&gt;,
		#&lt;Pod::Specification name="CategoryCluster"&gt;,
		...
	]
}
</code></pre>

<p>è€Œè¿™äº› <code>Specification</code> å°±åŒ…å«äº†å½“å‰å·¥ç¨‹ä¾èµ–çš„æ‰€æœ‰ç¬¬ä¸‰æ–¹æ¡†æ¶ï¼Œå…¶ä¸­åŒ…å«äº†åå­—ã€ç‰ˆæœ¬ã€æºç­‰ä¿¡æ¯ï¼Œç”¨äºä¾èµ–çš„ä¸‹è½½ã€‚</p>

<h4 id="ä¸‹è½½ä¾èµ–">ä¸‹è½½ä¾èµ–</h4>

<p>åœ¨ä¾èµ–å…³ç³»è§£å†³è¿”å›äº†ä¸€ç³»åˆ— <code>Specification</code> å¯¹è±¡ä¹‹åï¼Œå°±åˆ°äº† Pod install çš„ç¬¬äºŒéƒ¨åˆ†ï¼Œä¸‹è½½ä¾èµ–ï¼š</p>

<pre><code class="language-ruby">def install_pod_sources
  @installed_specs = []
  pods_to_install = sandbox_state.added | sandbox_state.changed
  title_options = { :verbose_prefix =&gt; '-&gt; '.green }
  root_specs.sort_by(&amp;:name).each do |spec|
	if pods_to_install.include?(spec.name)
	  if sandbox_state.changed.include?(spec.name) &amp;&amp; sandbox.manifest
		previous = sandbox.manifest.version(spec.name)
		title = "Installing #{spec.name} #{spec.version} (was #{previous})"
	  else
		title = "Installing #{spec}"
	  end
	  UI.titled_section(title.green, title_options) do
		install_source_of_pod(spec.name)
	  end
	else
	  UI.titled_section("Using #{spec}", title_options) do
		create_pod_installer(spec.name)
	  end
	end
  end
end
</code></pre>

<p>åœ¨è¿™ä¸ªæ–¹æ³•ä¸­ä½ ä¼šçœ‹åˆ°æ›´å¤šç†Ÿæ‚‰çš„æç¤ºï¼ŒCocoaPods ä¼šä½¿ç”¨æ²™ç›’ï¼ˆsandboxï¼‰å­˜å‚¨å·²æœ‰ä¾èµ–çš„æ•°æ®ï¼Œåœ¨æ›´æ–°ç°æœ‰çš„ä¾èµ–æ—¶ï¼Œä¼šæ ¹æ®ä¾èµ–çš„ä¸åŒçŠ¶æ€æ˜¾ç¤ºå‡ºä¸åŒçš„æç¤ºä¿¡æ¯ï¼š</p>

<pre><code class="language-ruby">-&gt; Using AFNetworking (3.1.0)

-&gt; Using AKPickerView (0.2.7)

-&gt; Using BlocksKit (2.2.5) was (2.2.4)

-&gt; Installing MBProgressHUD (1.0.0)
...
</code></pre>

<p>è™½ç„¶è¿™é‡Œçš„æç¤ºä¼šæœ‰ä¸‰ç§ï¼Œä½†æ˜¯ CocoaPods åªä¼šæ ¹æ®ä¸åŒçš„çŠ¶æ€åˆ†åˆ«è°ƒç”¨ä¸¤ç§æ–¹æ³•ï¼š</p>

<ul>
  <li><code>install_source_of_pod</code></li>
  <li><code>create_pod_installer</code></li>
</ul>

<p><code>create_pod_installer</code> æ–¹æ³•åªä¼šåˆ›å»ºä¸€ä¸ª <code>PodSourceInstaller</code> çš„å®ä¾‹ï¼Œç„¶ååŠ å…¥ <code>pod_installers</code> æ•°ç»„ä¸­ï¼Œå› ä¸ºä¾èµ–çš„ç‰ˆæœ¬æ²¡æœ‰æ”¹å˜ï¼Œæ‰€ä»¥ä¸éœ€è¦é‡æ–°ä¸‹è½½ï¼Œè€Œå¦ä¸€ä¸ªæ–¹æ³•çš„ <code>install_source_of_pod</code> çš„è°ƒç”¨æ ˆéå¸¸åºå¤§ï¼š</p>

<pre><code class="language-ruby">installer.install_source_of_pod
|-- create_pod_installer
|	`-- PodSourceInstaller.new
`-- podSourceInstaller.install!
	`-- download_source
	   `-- Downloader.download
		   `-- Downloader.download_request
			   `-- Downloader.download_source
				   |-- Downloader.for_target
				   |   |-- Downloader.class_for_options
				   |   `-- Git/HTTP/Mercurial/Subversion.new
				   |-- Git/HTTP/Mercurial/Subversion.download
				   `-- Git/HTTP/Mercurial/Subversion.download!
					   `-- Git.clone
</code></pre>

<p>åœ¨è°ƒç”¨æ ˆçš„æœ«ç«¯ <code>Downloader.download_source</code> ä¸­æ‰§è¡Œäº†å¦ä¸€ä¸ª CocoaPods ç»„ä»¶ <strong>CocoaPods-Download</strong> ä¸­çš„æ–¹æ³•ï¼š</p>

<pre><code class="language-ruby">def self.download_source(target, params)
  FileUtils.rm_rf(target)
  downloader = Downloader.for_target(target, params)
  downloader.download
  target.mkpath

  if downloader.options_specific?
	params
  else
	downloader.checkout_options
  end
end
</code></pre>

<p>æ–¹æ³•ä¸­è°ƒç”¨çš„ <code>for_target</code> æ ¹æ®ä¸åŒçš„æºä¼šåˆ›å»ºä¸€ä¸ªä¸‹è½½å™¨ï¼Œå› ä¸ºä¾èµ–å¯èƒ½é€šè¿‡ä¸åŒçš„åè®®æˆ–è€…æ–¹å¼è¿›è¡Œä¸‹è½½ï¼Œæ¯”å¦‚è¯´ Git/HTTP/SVN ç­‰ç­‰ï¼Œç»„ä»¶ CocoaPods-Downloader å°±ä¼šæ ¹æ® Podfile ä¸­ä¾èµ–çš„å‚æ•°é€‰é¡¹ä½¿ç”¨ä¸åŒçš„æ–¹æ³•ä¸‹è½½ä¾èµ–ã€‚</p>

<p>å¤§éƒ¨åˆ†çš„ä¾èµ–éƒ½ä¼šè¢«ä¸‹è½½åˆ° <code>~/Library/Caches/CocoaPods/Pods/Release/</code> è¿™ä¸ªæ–‡ä»¶å¤¹ä¸­ï¼Œç„¶åä»è¿™ä¸ªè¿™é‡Œå¤åˆ¶åˆ°é¡¹ç›®å·¥ç¨‹ç›®å½•ä¸‹çš„ <code>./Pods</code> ä¸­ï¼Œè¿™ä¹Ÿå°±å®Œæˆäº†æ•´ä¸ª CocoaPods çš„ä¸‹è½½æµç¨‹ã€‚</p>

<h4 id="ç”Ÿæˆ-podsxcodeproj">ç”Ÿæˆ Pods.xcodeproj</h4>

<p>CocoaPods é€šè¿‡ç»„ä»¶ CocoaPods-Downloader å·²ç»æˆåŠŸå°†æ‰€æœ‰çš„ä¾èµ–ä¸‹è½½åˆ°äº†å½“å‰å·¥ç¨‹ä¸­ï¼Œè¿™é‡Œä¼šå°†æ‰€æœ‰çš„ä¾èµ–æ‰“åŒ…åˆ° <code>Pods.xcodeproj</code> ä¸­ï¼š</p>

<pre><code class="language-ruby">def generate_pods_project(generator = create_generator)
  UI.section 'Generating Pods project' do
	generator.generate!
	@pods_project = generator.project
	run_podfile_post_install_hooks
	generator.write
	generator.share_development_pod_schemes
	write_lockfiles
  end
end
</code></pre>

<p><code>generate_pods_project</code> ä¸­ä¼šæ‰§è¡Œ <code>PodsProjectGenerator</code> çš„å®ä¾‹æ–¹æ³• <code>generate!</code>ï¼š</p>

<pre><code class="language-ruby">def generate!
  prepare
  install_file_references
  install_libraries
  set_target_dependencies
end
</code></pre>

<p>è¿™ä¸ªæ–¹æ³•åšäº†å‡ ä»¶å°äº‹ï¼š</p>

<ul>
  <li>ç”Ÿæˆ <code>Pods.xcodeproj</code> å·¥ç¨‹</li>
  <li>å°†ä¾èµ–ä¸­çš„æ–‡ä»¶åŠ å…¥å·¥ç¨‹</li>
  <li>å°†ä¾èµ–ä¸­çš„ Library åŠ å…¥å·¥ç¨‹</li>
  <li>è®¾ç½®ç›®æ ‡ä¾èµ–ï¼ˆTarget Dependenciesï¼‰</li>
</ul>

<p>è¿™å‡ ä»¶äº‹æƒ…éƒ½ç¦»ä¸å¼€ CocoaPods çš„å¦å¤–ä¸€ä¸ªç»„ä»¶ Xcodeprojï¼Œè¿™æ˜¯ä¸€ä¸ªå¯ä»¥æ“ä½œä¸€ä¸ª Xcode å·¥ç¨‹ä¸­çš„ Group ä»¥åŠæ–‡ä»¶çš„ç»„ä»¶ï¼Œæˆ‘ä»¬éƒ½çŸ¥é“å¯¹ Xcode å·¥ç¨‹çš„ä¿®æ”¹å¤§å¤šæ•°æƒ…å†µä¸‹éƒ½æ˜¯å¯¹ä¸€ä¸ªåå« <code>project.pbxproj</code> çš„æ–‡ä»¶è¿›è¡Œä¿®æ”¹ï¼Œè€Œ Xcodeproj è¿™ä¸ªç»„ä»¶å°±æ˜¯ CocoaPods å›¢é˜Ÿå¼€å‘çš„ç”¨äºæ“ä½œè¿™ä¸ªæ–‡ä»¶çš„ç¬¬ä¸‰æ–¹åº“ã€‚</p>

<h4 id="ç”Ÿæˆ-workspace">ç”Ÿæˆ workspace</h4>

<p>æœ€åçš„è¿™ä¸€éƒ¨åˆ†ä¸ç”Ÿæˆ <code>Pods.xcodeproj</code> çš„è¿‡ç¨‹æœ‰ä¸€äº›ç›¸ä¼¼ï¼Œè¿™é‡Œä½¿ç”¨çš„ç±»æ˜¯ <code>UserProjectIntegrator</code>ï¼Œè°ƒç”¨æ–¹æ³• <code>integrate!</code> æ—¶ï¼Œå°±ä¼šå¼€å§‹é›†æˆå·¥ç¨‹æ‰€éœ€è¦çš„ Targetï¼š</p>

<pre><code class="language-ruby">def integrate!
  create_workspace
  integrate_user_targets
  warn_about_xcconfig_overrides
  save_projects
end
</code></pre>

<p>å¯¹äºè¿™ä¸€éƒ¨åˆ†çš„ä»£ç ï¼Œä¹Ÿä¸æ˜¯å¾ˆæƒ³å±•å¼€æ¥ç»†è°ˆï¼Œç®€å•ä»‹ç»ä¸€ä¸‹è¿™é‡Œçš„ä»£ç éƒ½åšäº†ä»€ä¹ˆï¼Œé¦–å…ˆä¼šé€šè¿‡ <code>Xcodeproj::Workspace</code> åˆ›å»ºä¸€ä¸ª workspaceï¼Œä¹‹åä¼šè·å–æ‰€æœ‰è¦é›†æˆçš„ Target å®ä¾‹ï¼Œè°ƒç”¨å®ƒä»¬çš„ <code>integrate!</code> æ–¹æ³•ï¼š</p>

<pre><code class="language-ruby">def integrate!
  UI.section(integration_message) do
	XCConfigIntegrator.integrate(target, native_targets)

	add_pods_library
	add_embed_frameworks_script_phase
	remove_embed_frameworks_script_phase_from_embedded_targets
	add_copy_resources_script_phase
	add_check_manifest_lock_script_phase
  end
end
</code></pre>

<p>æ–¹æ³•å°†æ¯ä¸€ä¸ª Target åŠ å…¥åˆ°äº†å·¥ç¨‹ï¼Œä½¿ç”¨ Xcodeproj ä¿®æ”¹ <code>Copy Resource Script Phrase</code> ç­‰è®¾ç½®ï¼Œä¿å­˜ <code>project.pbxproj</code>ï¼Œæ•´ä¸ª Pod install çš„è¿‡ç¨‹å°±ç»“æŸäº†ã€‚</p>

<h2 id="æ€»ç»“">æ€»ç»“</h2>

<p>æœ€åæƒ³è¯´çš„æ˜¯ pod install å’Œ pod update åŒºåˆ«è¿˜æ˜¯æ¯”è¾ƒå¤§çš„ï¼Œæ¯æ¬¡åœ¨æ‰§è¡Œ pod install æˆ–è€… update æ—¶æœ€åéƒ½ä¼šç”Ÿæˆæˆ–è€…ä¿®æ”¹ <code>Podfile.lock</code> æ–‡ä»¶ï¼Œå…¶ä¸­å‰è€…å¹¶ä¸ä¼šä¿®æ”¹ <code>Podfile.lock</code> ä¸­<strong>æ˜¾ç¤ºæŒ‡å®š</strong>çš„ç‰ˆæœ¬ï¼Œè€Œåè€…ä¼šä¼šæ— è§†è¯¥æ–‡ä»¶çš„å†…å®¹ï¼Œå°è¯•å°†æ‰€æœ‰çš„ pod æ›´æ–°åˆ°æœ€æ–°ç‰ˆã€‚</p>

<p>CocoaPods å·¥ç¨‹çš„ä»£ç è™½ç„¶éå¸¸å¤šï¼Œä¸è¿‡ä»£ç çš„é€»è¾‘éå¸¸æ¸…æ™°ï¼Œæ•´ä¸ªç®¡ç†å¹¶ä¸‹è½½ä¾èµ–çš„è¿‡ç¨‹éå¸¸ç¬¦åˆç›´è§‰ä»¥åŠé€»è¾‘ã€‚</p>

<h2 id="å…¶å®ƒ">å…¶å®ƒ</h2>

<blockquote>
  <p>Github Repoï¼š<a href="https://github.com/nju520/iOS-Source-Code-Analyze">iOS-Source-Code-Analyze</a></p>

</blockquote>

<blockquote>

  <p>Source: http://nju520.me/cocoapods</p>
</blockquote>

  ]]></description>
</item>


  </channel>
</rss>
